<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 登入處理中 | ZN Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4285F4; /* Google Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            color: #34A853; /* Google Green */
            font-size: 24px;
            margin: 20px 0;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-size: 18px;
            margin: 20px 0;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        .user-info img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .user-info h3 {
            color: #333;
            margin: 10px 0;
        }

        .user-info .badge {
            display: inline-block;
            padding: 5px 15px;
            background: #4285F4; /* Google Blue */
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .user-info .badge.paid {
            background: #FBBC05; /* Google Yellow */
            color: #333;
        }

        .btn.redirect {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn.redirect:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .countdown {
            font-size: 18px;
            color: #667eea;
            margin-top: 15px;
            font-weight: bold;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Google 登入處理中</h2>
        <div class="loader" id="loader"></div>
        <div id="message">正在從 Supabase 驗證身份...</div>

        <div class="user-info" id="userInfo">
            <img id="userPicture" src="https://placehold.co/80" alt="用戶頭像">
            <h3 id="userName"></h3>
            <span class="badge" id="memberBadge"></span>
        </div>

        <div class="countdown" id="countdown"></div>

        <button class="btn redirect" id="manualRedirect" style="display: none;">
            立即返回測驗系統
        </button>

        <!-- Debug 資訊區塊 (開發時可開啟) -->
        <div class="debug-info" id="debugInfo"></div>

    </div>

    <script>
        // 設定返回的目標頁面 URL
        const REDIRECT_URL = '/GenAI/index.html';  // ✅ 跳轉到主系統（模組化版本）
        // 你的 n8n Google 登入 Webhook URL (這個 URL 會處理 token 交換和資料同步)
        const N8N_GOOGLE_WEBHOOK_URL = 'https://nickleo9.zeabur.app/webhook/google-login';
        
        const messageDiv = document.getElementById('message');
        const loaderDiv = document.getElementById('loader');
        const userInfoDiv = document.getElementById('userInfo');
        const countdownDiv = document.getElementById('countdown');
        const manualRedirectBtn = document.getElementById('manualRedirect');
        const debugInfoDiv = document.getElementById('debugInfo');

        // 從 URL #hash 取得參數 (Supabase 返回的方式)
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const errorCode = urlParams.get('error');

        manualRedirectBtn.addEventListener('click', () => redirectToMain());

        // Debug 函數 (開發時可用)
        function logDebug(message, data = null) {
            console.log(message, data);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = `[${timestamp}] ${message}`;
            debugInfoDiv.innerHTML += `<div>${logEntry}</div>`;
            if (data) {
                debugInfoDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            // 開發時取消此行註解以顯示 debug 資訊
            // debugInfoDiv.classList.add('show');
        }

        // 核心邏輯
        if (errorCode) {
            handleError(`Google 登入失敗: ${urlParams.get('error_description') || errorCode}`);
        } else if (accessToken) {
            sendTokenToWebhook(accessToken, refreshToken);
        } else {
            handleError('❌ 未收到登入憑證 (Access Token)');
        }


        // 步驟 1: 將 Token POST 給 n8n 進行後端處理
        async function sendTokenToWebhook(access_token, refresh_token) {
            try {
                messageDiv.innerHTML = '正在同步資料到雲端...';
                logDebug('開始發送 Token 到 n8n');
                
                // 由於 Supabase 登入成功後,Token 會儲存在前端,這裡直接將 Token 傳給 n8n
                const response = await fetch(N8N_GOOGLE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        access_token: access_token,
                        refresh_token: refresh_token,
                        login_type: 'google' 
                    })
                });

                if (!response.ok) {
                    throw new Error(`Webhook 處理失敗,狀態碼: ${response.status}`);
                }

                const data = await response.json();
                logDebug('n8n 回應資料:', data);
                
                // 隱藏載入動畫
                loaderDiv.style.display = 'none';

                if (data.status === 'success') {
                    
                    // 🎯 關鍵修正:正確處理頭像 URL
                    // 優先使用 pictureUrl,其次是 avatar,最後提供預設值
                    let avatarUrl = data.pictureUrl || data.avatar || 'https://placehold.co/80';
                    
                    logDebug('原始 avatarUrl:', avatarUrl);
                    
                    // 🎯 安全檢查:確保 avatarUrl 存在且為字串後才進行操作
                    if (avatarUrl && typeof avatarUrl === 'string' && avatarUrl.startsWith('http://')) {
                        avatarUrl = avatarUrl.replace('http://', 'https://');
                        logDebug('已轉換為 HTTPS:', avatarUrl);
                    }
                    
                    // 🔥 關鍵修正:資料結構必須完全匹配 web.html 的 showUserInfo 期望
                    const userData = {
                        // 核心欄位 (web.html showUserInfo 會使用)
                        displayName: data.displayName || data.email?.split('@')[0] || '使用者',
                        name: data.displayName || data.email?.split('@')[0] || '使用者',
                        pictureUrl: avatarUrl,
                        avatar: avatarUrl,
                        
                        // 識別與會員欄位
                        userId: data.Google_user_id || data.google_id,
                        google_id: data.Google_user_id || data.google_id,
                        email: data.email,
                        member_level: data.member_level || '免費會員',
                        
                        // 元資料
                        login_type: 'google',
                        last_login: new Date().toLocaleString('zh-TW')
                    };

                    logDebug('準備儲存的用戶資料:', userData);
                    localStorage.setItem('user_data', JSON.stringify(userData));

                    messageDiv.className = 'success';
                    messageDiv.innerHTML = '✓ Google 登入成功!';
                    
                    // 顯示用戶資訊
                    displayUserInfo(userData);

                    // 2秒後自動跳轉
                    startCountdown(2);
                } else {
                    throw new Error(data.message || 'n8n 服務端返回錯誤');
                }

            } catch (error) {
                console.error('❌ Google 登入處理錯誤:', error);
                logDebug('錯誤詳情:', error);
                handleError(`資料同步錯誤: ${error.message}`);
            }
        }


        // 顯示用戶資訊
        function displayUserInfo(user) {
            if (!user) return;

            userInfoDiv.classList.add('show');
            
            const userPicture = document.getElementById('userPicture');
            const userName = document.getElementById('userName');
            const memberBadge = document.getElementById('memberBadge');
            const memberLevel = user.member_level || '免費會員';

            userPicture.src = user.pictureUrl || user.avatar || 'https://placehold.co/80';
            userName.textContent = user.displayName || user.name || user.email || '使用者';
            memberBadge.textContent = memberLevel;
            
            // 根據會員等級設定樣式
            if (memberLevel.includes('付費')) {
                memberBadge.classList.add('paid');
            } else {
                memberBadge.classList.remove('paid');
            }

            logDebug('用戶資訊已顯示');
        }
        
        // 錯誤處理
        function handleError(msg) {
            loaderDiv.style.display = 'none';
            messageDiv.className = 'error';
            messageDiv.innerHTML = msg;
            showManualRedirect();
            logDebug('錯誤:', msg);
        }

        // 倒數計時與自動跳轉
        function startCountdown(seconds) {
            let remaining = seconds;
            countdownDiv.style.display = 'block';
            
            const interval = setInterval(() => {
                countdownDiv.innerHTML = `⏱️ ${remaining} 秒後自動跳轉...`;
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(interval);
                    redirectToMain();
                }
            }, 1000);

            showManualRedirect();
        }

        function showManualRedirect() {
            manualRedirectBtn.style.display = 'inline-block';
        }

        function redirectToMain() {
            logDebug('準備跳轉到:', REDIRECT_URL);
            window.location.href = REDIRECT_URL;
        }

    </script>
</body>
</html>
