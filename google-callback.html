<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google ÁôªÂÖ•ËôïÁêÜ‰∏≠ | ZN Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4285F4; /* Google Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            color: #34A853; /* Google Green */
            font-size: 24px;
            margin: 20px 0;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-size: 18px;
            margin: 20px 0;
        }

        .user-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        .user-info img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .user-info h3 {
            color: #333;
            margin: 10px 0;
        }

        .user-info .badge {
            display: inline-block;
            padding: 5px 15px;
            background: #4285F4; /* Google Blue */
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .user-info .badge.paid {
            background: #FBBC05; /* Google Yellow */
            color: #333;
        }

        .btn.redirect {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn.redirect:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .countdown {
            font-size: 18px;
            color: #667eea;
            margin-top: 15px;
            font-weight: bold;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Google ÁôªÂÖ•ËôïÁêÜ‰∏≠</h2>
        <div class="loader" id="loader"></div>
        <div id="message">Ê≠£Âú®Âæû Supabase È©óË≠âË∫´‰ªΩ...</div>

        <div class="user-info" id="userInfo">
            <img id="userPicture" src="https://placehold.co/80" alt="Áî®Êà∂È†≠ÂÉè">
            <h3 id="userName"></h3>
            <span class="badge" id="memberBadge"></span>
        </div>

        <div class="countdown" id="countdown"></div>

        <button class="btn redirect" id="manualRedirect" style="display: none;">
            Á´ãÂç≥ËøîÂõûÊ∏¨È©óÁ≥ªÁµ±
        </button>

        <!-- Debug Ë≥áË®äÂçÄÂ°ä (ÈñãÁôºÊôÇÂèØÈñãÂïü) -->
        <div class="debug-info" id="debugInfo"></div>

    </div>

    <script>
        // Ë®≠ÂÆöËøîÂõûÁöÑÁõÆÊ®ôÈ†ÅÈù¢ URL
        const REDIRECT_URL = '/GenAI/index.html';  // ‚úÖ Ë∑≥ËΩâÂà∞‰∏ªÁ≥ªÁµ±ÔºàÊ®°ÁµÑÂåñÁâàÊú¨Ôºâ
        // ‰Ω†ÁöÑ n8n Google ÁôªÂÖ• Webhook URL (ÈÄôÂÄã URL ÊúÉËôïÁêÜ token ‰∫§ÊèõÂíåË≥áÊñôÂêåÊ≠•)
        const N8N_GOOGLE_WEBHOOK_URL = 'https://nickleo9.zeabur.app/webhook/google-login';
        
        const messageDiv = document.getElementById('message');
        const loaderDiv = document.getElementById('loader');
        const userInfoDiv = document.getElementById('userInfo');
        const countdownDiv = document.getElementById('countdown');
        const manualRedirectBtn = document.getElementById('manualRedirect');
        const debugInfoDiv = document.getElementById('debugInfo');

        // Âæû URL #hash ÂèñÂæóÂèÉÊï∏ (Supabase ËøîÂõûÁöÑÊñπÂºè)
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const errorCode = urlParams.get('error');

        manualRedirectBtn.addEventListener('click', () => redirectToMain());

        // Debug ÂáΩÊï∏ (ÈñãÁôºÊôÇÂèØÁî®)
        function logDebug(message, data = null) {
            console.log(message, data);
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = `[${timestamp}] ${message}`;
            debugInfoDiv.innerHTML += `<div>${logEntry}</div>`;
            if (data) {
                debugInfoDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            // ÈñãÁôºÊôÇÂèñÊ∂àÊ≠§Ë°åË®ªËß£‰ª•È°ØÁ§∫ debug Ë≥áË®ä
            // debugInfoDiv.classList.add('show');
        }

        // Ê†∏ÂøÉÈÇèËºØ
        if (errorCode) {
            handleError(`Google ÁôªÂÖ•Â§±Êïó: ${urlParams.get('error_description') || errorCode}`);
        } else if (accessToken) {
            sendTokenToWebhook(accessToken, refreshToken);
        } else {
            handleError('‚ùå Êú™Êî∂Âà∞ÁôªÂÖ•ÊÜëË≠â (Access Token)');
        }


        // Ê≠•È©ü 1: Â∞á Token POST Áµ¶ n8n ÈÄ≤Ë°åÂæåÁ´ØËôïÁêÜ
        async function sendTokenToWebhook(access_token, refresh_token) {
            try {
                messageDiv.innerHTML = 'Ê≠£Âú®ÂêåÊ≠•Ë≥áÊñôÂà∞Èõ≤Á´Ø...';
                logDebug('ÈñãÂßãÁôºÈÄÅ Token Âà∞ n8n');
                
                // Áî±Êñº Supabase ÁôªÂÖ•ÊàêÂäüÂæå,Token ÊúÉÂÑ≤Â≠òÂú®ÂâçÁ´Ø,ÈÄôË£°Áõ¥Êé•Â∞á Token ÂÇ≥Áµ¶ n8n
                const response = await fetch(N8N_GOOGLE_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        access_token: access_token,
                        refresh_token: refresh_token,
                        login_type: 'google' 
                    })
                });

                if (!response.ok) {
                    throw new Error(`Webhook ËôïÁêÜÂ§±Êïó,ÁãÄÊÖãÁ¢º: ${response.status}`);
                }

                const data = await response.json();
                logDebug('n8n ÂõûÊáâË≥áÊñô:', data);
                
                // Èö±ËóèËºâÂÖ•ÂãïÁï´
                loaderDiv.style.display = 'none';

                if (data.status === 'success') {
                    
                    // üéØ ÈóúÈçµ‰øÆÊ≠£:Ê≠£Á¢∫ËôïÁêÜÈ†≠ÂÉè URL
                    // ÂÑ™ÂÖà‰ΩøÁî® pictureUrl,ÂÖ∂Ê¨°ÊòØ avatar,ÊúÄÂæåÊèê‰æõÈ†êË®≠ÂÄº
                    let avatarUrl = data.pictureUrl || data.avatar || 'https://placehold.co/80';
                    
                    logDebug('ÂéüÂßã avatarUrl:', avatarUrl);
                    
                    // üéØ ÂÆâÂÖ®Ê™¢Êü•:Á¢∫‰øù avatarUrl Â≠òÂú®‰∏îÁÇ∫Â≠ó‰∏≤ÂæåÊâçÈÄ≤Ë°åÊìç‰Ωú
                    if (avatarUrl && typeof avatarUrl === 'string' && avatarUrl.startsWith('http://')) {
                        avatarUrl = avatarUrl.replace('http://', 'https://');
                        logDebug('Â∑≤ËΩâÊèõÁÇ∫ HTTPS:', avatarUrl);
                    }
                    
                    // üî• ÈóúÈçµ‰øÆÊ≠£:Ë≥áÊñôÁµêÊßãÂøÖÈ†àÂÆåÂÖ®ÂåπÈÖç web.html ÁöÑ showUserInfo ÊúüÊúõ
                    const userData = {
                        // Ê†∏ÂøÉÊ¨Ñ‰Ωç (web.html showUserInfo ÊúÉ‰ΩøÁî®)
                        displayName: data.displayName || data.email?.split('@')[0] || '‰ΩøÁî®ËÄÖ',
                        name: data.displayName || data.email?.split('@')[0] || '‰ΩøÁî®ËÄÖ',
                        pictureUrl: avatarUrl,
                        avatar: avatarUrl,
                        
                        // Ë≠òÂà•ËàáÊúÉÂì°Ê¨Ñ‰Ωç
                        userId: data.Google_user_id || data.google_id,
                        google_id: data.Google_user_id || data.google_id,
                        email: data.email,
                        member_level: data.member_level || 'ÂÖçË≤ªÊúÉÂì°',
                        
                        // ÂÖÉË≥áÊñô
                        login_type: 'google',
                        last_login: new Date().toLocaleString('zh-TW')
                    };

                    logDebug('Ê∫ñÂÇôÂÑ≤Â≠òÁöÑÁî®Êà∂Ë≥áÊñô:', userData);
                    localStorage.setItem('user_data', JSON.stringify(userData));

                    messageDiv.className = 'success';
                    messageDiv.innerHTML = '‚úì Google ÁôªÂÖ•ÊàêÂäü!';
                    
                    // È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
                    displayUserInfo(userData);

                    // 2ÁßíÂæåËá™ÂãïË∑≥ËΩâ
                    startCountdown(2);
                } else {
                    throw new Error(data.message || 'n8n ÊúçÂãôÁ´ØËøîÂõûÈåØË™§');
                }

            } catch (error) {
                console.error('‚ùå Google ÁôªÂÖ•ËôïÁêÜÈåØË™§:', error);
                logDebug('ÈåØË™§Ë©≥ÊÉÖ:', error);
                handleError(`Ë≥áÊñôÂêåÊ≠•ÈåØË™§: ${error.message}`);
            }
        }


        // È°ØÁ§∫Áî®Êà∂Ë≥áË®ä
        function displayUserInfo(user) {
            if (!user) return;

            userInfoDiv.classList.add('show');
            
            const userPicture = document.getElementById('userPicture');
            const userName = document.getElementById('userName');
            const memberBadge = document.getElementById('memberBadge');
            const memberLevel = user.member_level || 'ÂÖçË≤ªÊúÉÂì°';

            userPicture.src = user.pictureUrl || user.avatar || 'https://placehold.co/80';
            userName.textContent = user.displayName || user.name || user.email || '‰ΩøÁî®ËÄÖ';
            memberBadge.textContent = memberLevel;
            
            // Ê†πÊìöÊúÉÂì°Á≠âÁ¥öË®≠ÂÆöÊ®£Âºè
            if (memberLevel.includes('‰ªòË≤ª')) {
                memberBadge.classList.add('paid');
            } else {
                memberBadge.classList.remove('paid');
            }

            logDebug('Áî®Êà∂Ë≥áË®äÂ∑≤È°ØÁ§∫');
        }
        
        // ÈåØË™§ËôïÁêÜ
        function handleError(msg) {
            loaderDiv.style.display = 'none';
            messageDiv.className = 'error';
            messageDiv.innerHTML = msg;
            showManualRedirect();
            logDebug('ÈåØË™§:', msg);
        }

        // ÂÄíÊï∏Ë®àÊôÇËàáËá™ÂãïË∑≥ËΩâ
        function startCountdown(seconds) {
            let remaining = seconds;
            countdownDiv.style.display = 'block';
            
            const interval = setInterval(() => {
                countdownDiv.innerHTML = `‚è±Ô∏è ${remaining} ÁßíÂæåËá™ÂãïË∑≥ËΩâ...`;
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(interval);
                    redirectToMain();
                }
            }, 1000);

            showManualRedirect();
        }

        function showManualRedirect() {
            manualRedirectBtn.style.display = 'inline-block';
        }

        function redirectToMain() {
            logDebug('Ê∫ñÂÇôË∑≥ËΩâÂà∞:', REDIRECT_URL);
            window.location.href = REDIRECT_URL;
        }

    </script>
</body>
</html>
