<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <title>Google 登入處理中...</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <div class="loading-container">
            <!-- 藍色旋轉指示器 -->
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full mx-auto mb-4"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">正在處理 Google 登入...</h3>
            <p class="text-gray-500 mb-6">請稍候，我們正在為您設定帳戶資料。</p>
            <div id="status" class="text-sm font-medium text-blue-600">驗證中...</div>
        </div>
    </div>
    
    <script>
    // 💡 小提醒：這是您在 n8n 中處理 Supabase Token 的 Webhook URL
    const N8N_PROCESSING_WEBHOOK = 'https://nickleo9.zeabur.app/webhook/google-login';
    
    /**
     * 處理 Google 登入回調函式。
     * 1. 從 URL 雜湊 (#hash) 取得 Supabase 傳來的 Access Token。
     * 2. 將 Token POST 給 n8n Webhook。
     * 3. 接收 n8n 返回的會員資料，並儲存到瀏覽器。
     * 4. 跳轉回主頁。
     */
    async function handleGoogleLoginCallback() {
        const statusDiv = document.getElementById('status');
        
        try {
            // 從 URL Hash 取得 Access Token
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');
            
            if (!accessToken) {
                const errorDesc = urlParams.get('error_description') || '登入流程未完成或發生錯誤';
                throw new Error(errorDesc);
            }
            
            statusDiv.textContent = '身份驗證成功，正在同步資料到會員系統...';
            
            // 將 Token 發送給 n8n
            const response = await fetch(N8N_PROCESSING_WEBHOOK, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    access_token: accessToken,
                    refresh_token: refreshToken,
                    login_type: 'google'
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success' && data.user_data) {
                // 儲存用戶資料到 localStorage 的 'user_data' 鍵中
                localStorage.setItem('user_data', JSON.stringify({
                    ...data.user_data,
                    login_type: 'google',
                    member_level: data.user_data.member_level || '免費會員' // 確保有等級資訊
                }));
                
                statusDiv.textContent = '✨ 登入成功！正在跳轉主頁...';
                
                // 跳轉回主頁面 (web.html)
                setTimeout(() => {
                    window.location.href = window.location.origin + '/GenAI/web.html'; 
                }, 1500);
            } else {
                const errorMsg = data.message || '後端同步資料失敗。';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            statusDiv.textContent = '❌ 登入失敗：' + error.message;
            console.error('Google 登入錯誤:', error);
            
            // 錯誤發生後，3秒後跳轉回主頁
            setTimeout(() => {
                 window.location.href = window.location.origin + '/GenAI/web.html'; 
            }, 3000);
        }
    }
    
    // 立即執行登入處理
    document.addEventListener('DOMContentLoaded', handleGoogleLoginCallback);
    </script>
</body>
</html>
