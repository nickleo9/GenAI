<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <title>Google ç™»å…¥è™•ç†ä¸­...</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
        <div class="loading-container">
            <!-- è—è‰²æ—‹è½‰æŒ‡ç¤ºå™¨ -->
            <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full mx-auto mb-4"></div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">æ­£åœ¨è™•ç† Google ç™»å…¥...</h3>
            <p class="text-gray-500 mb-6">è«‹ç¨å€™ï¼Œæˆ‘å€‘æ­£åœ¨ç‚ºæ‚¨è¨­å®šå¸³æˆ¶è³‡æ–™ã€‚</p>
            <div id="status" class="text-sm font-medium text-blue-600">é©—è­‰ä¸­...</div>
        </div>
    </div>
    
    <script>
    // ğŸ’¡ å°æé†’ï¼šé€™æ˜¯æ‚¨åœ¨ n8n ä¸­è™•ç† Supabase Token çš„ Webhook URL
    const N8N_PROCESSING_WEBHOOK = 'https://nickleo9.zeabur.app/webhook/google-login';
    
    /**
     * è™•ç† Google ç™»å…¥å›èª¿å‡½å¼ã€‚
     * 1. å¾ URL é›œæ¹Š (#hash) å–å¾— Supabase å‚³ä¾†çš„ Access Tokenã€‚
     * 2. å°‡ Token POST çµ¦ n8n Webhookã€‚
     * 3. æ¥æ”¶ n8n è¿”å›çš„æœƒå“¡è³‡æ–™ï¼Œä¸¦å„²å­˜åˆ°ç€è¦½å™¨ã€‚
     * 4. è·³è½‰å›ä¸»é ã€‚
     */
    async function handleGoogleLoginCallback() {
        const statusDiv = document.getElementById('status');
        
        try {
            // å¾ URL Hash å–å¾— Access Token
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = urlParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token');
            
            if (!accessToken) {
                const errorDesc = urlParams.get('error_description') || 'ç™»å…¥æµç¨‹æœªå®Œæˆæˆ–ç™¼ç”ŸéŒ¯èª¤';
                throw new Error(errorDesc);
            }
            
            statusDiv.textContent = 'èº«ä»½é©—è­‰æˆåŠŸï¼Œæ­£åœ¨åŒæ­¥è³‡æ–™åˆ°æœƒå“¡ç³»çµ±...';
            
            // å°‡ Token ç™¼é€çµ¦ n8n
            const response = await fetch(N8N_PROCESSING_WEBHOOK, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    access_token: accessToken,
                    refresh_token: refreshToken,
                    login_type: 'google'
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success' && data.user_data) {
                // å„²å­˜ç”¨æˆ¶è³‡æ–™åˆ° localStorage çš„ 'user_data' éµä¸­
                localStorage.setItem('user_data', JSON.stringify({
                    ...data.user_data,
                    login_type: 'google',
                    member_level: data.user_data.member_level || 'å…è²»æœƒå“¡' // ç¢ºä¿æœ‰ç­‰ç´šè³‡è¨Š
                }));
                
                statusDiv.textContent = 'âœ¨ ç™»å…¥æˆåŠŸï¼æ­£åœ¨è·³è½‰ä¸»é ...';
                
                // è·³è½‰å›ä¸»é é¢ (web.html)
                setTimeout(() => {
                    window.location.href = window.location.origin + '/GenAI/web.html'; 
                }, 1500);
            } else {
                const errorMsg = data.message || 'å¾Œç«¯åŒæ­¥è³‡æ–™å¤±æ•—ã€‚';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            statusDiv.textContent = 'âŒ ç™»å…¥å¤±æ•—ï¼š' + error.message;
            console.error('Google ç™»å…¥éŒ¯èª¤:', error);
            
            // éŒ¯èª¤ç™¼ç”Ÿå¾Œï¼Œ3ç§’å¾Œè·³è½‰å›ä¸»é 
            setTimeout(() => {
                 window.location.href = window.location.origin + '/GenAI/web.html'; 
            }, 3000);
        }
    }
    
    // ç«‹å³åŸ·è¡Œç™»å…¥è™•ç†
    document.addEventListener('DOMContentLoaded', handleGoogleLoginCallback);
    </script>
</body>
</html>
