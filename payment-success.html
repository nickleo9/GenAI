<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»˜è²»æˆåŠŸ - iPAS AI é‘‘å®šç·´ç¿’ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .success-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            margin: 20px;
        }

        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 30px;
            animation: successPulse 1.5s ease-in-out infinite;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <!-- é©—è­‰ä¸­ç‹€æ…‹ -->
        <div id="verifying-section">
            <div class="loading-spinner"></div>
            <h3 class="mt-4">æ­£åœ¨é©—è­‰æ‚¨çš„ä»˜æ¬¾...</h3>
            <p class="text-muted">è«‹ç¨å€™,æˆ‘å€‘æ­£åœ¨ç¢ºèªæ‚¨çš„äº¤æ˜“</p>
        </div>

        <!-- æˆåŠŸç‹€æ…‹ -->
        <div id="success-section" style="display: none;">
            <i class="fas fa-check-circle success-icon"></i>
            <h1 class="mb-3">ğŸ‰ ä»˜è²»æˆåŠŸ!</h1>
            <h4 class="text-muted mb-4">æ­å–œæ‚¨å‡ç´šç‚ºä»˜è²»æœƒå“¡</h4>

            <!-- è§£é–åŠŸèƒ½åˆ—è¡¨ -->
            <div class="my-4">
                <h5 class="mb-3">âœ¨ å·²è§£é–å°ˆå±¬åŠŸèƒ½</h5>
                <div class="feature-badge">
                    <i class="fas fa-clipboard-check me-1"></i> æ¨¡æ“¬è€ƒè©¦æ¨¡å¼
                </div>
                <div class="feature-badge">
                    <i class="fas fa-cloud me-1"></i> é›²ç«¯åŒæ­¥é€²åº¦
                </div>
                <div class="feature-badge">
                    <i class="fas fa-file-download me-1"></i> éŒ¯é¡Œé›†åŒ¯å‡º
                </div>
                <div class="feature-badge">
                    <i class="fas fa-brain me-1"></i> AI å¼±é»åˆ†æ
                </div>
                <div class="feature-badge">
                    <i class="fas fa-headset me-1"></i> å„ªå…ˆå®¢æœ
                </div>
            </div>

            <!-- æœƒå“¡è³‡è¨Š -->
            <div class="alert alert-info mt-4">
                <h6><i class="fas fa-info-circle me-2"></i>æœƒå“¡æ–¹æ¡ˆè³‡è¨Š</h6>
                <p class="mb-1">æ–¹æ¡ˆ:<span id="plan-type">è¼‰å…¥ä¸­...</span></p>
                <p class="mb-1">æœ‰æ•ˆæœŸé™:<span id="expiry-date">è¼‰å…¥ä¸­...</span></p>
                <p class="mb-0">è¨‚å–®ç·¨è™Ÿ:<span id="order-id">è¼‰å…¥ä¸­...</span></p>
            </div>

            <!-- å€’æ•¸è¨ˆæ™‚è·³è½‰ -->
            <div class="mt-4">
                <p class="text-muted">
                    <i class="fas fa-clock me-2"></i>
                    <span id="countdown" class="countdown">5</span> ç§’å¾Œè‡ªå‹•è·³è½‰å›é¦–é 
                </p>
                <button class="btn btn-primary btn-lg" onclick="redirectToHome()">
                    <i class="fas fa-home me-2"></i>ç«‹å³é–‹å§‹ä½¿ç”¨
                </button>
            </div>
        </div>

        <!-- å¤±æ•—ç‹€æ…‹ -->
        <div id="error-section" style="display: none;">
            <i class="fas fa-times-circle text-danger" style="font-size: 80px; margin-bottom: 30px;"></i>
            <h2 class="mb-3">ä»˜æ¬¾é©—è­‰å¤±æ•—</h2>
            <p class="text-muted mb-4">å¾ˆæŠ±æ­‰,ç„¡æ³•é©—è­‰æ‚¨çš„ä»˜æ¬¾</p>
            
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="error-message">è«‹è¯ç¹«å®¢æœè™•ç†</span>
            </div>

            <button class="btn btn-primary" onclick="location.href='web.html'">
                <i class="fas fa-arrow-left me-2"></i>è¿”å›é¦–é 
            </button>
        </div>

        <!-- è£½ä½œè€…è³‡è¨Š -->
        <div class="mt-5 pt-4 border-top">
            <small class="text-muted">
                <strong>Nick Chang</strong> | nickleo051216@gmail.com | 0932-684-051<br>
                <a href="https://portaly.cc/zn.studio" target="_blank" class="text-decoration-none">
                    <i class="fas fa-globe me-1"></i>ZN Studio
                </a> | 
                <a href="https://www.threads.com/@nickai216" target="_blank" class="text-decoration-none">
                    <i class="fab fa-threads me-1"></i>@nickai216
                </a>
            </small>
        </div>
    </div>

    <script>
        // ==================== ä»˜è²»æˆåŠŸè™•ç†é‚è¼¯ ====================
        
        const PaymentSuccessHandler = {
            // n8n Webhook URL (ç”¨æ–¼é©—è­‰ä»˜æ¬¾ä¸¦æ›´æ–°æœƒå“¡ç­‰ç´š)
            N8N_VERIFY_URL: 'https://nickleo9.zeabur.app/webhook/verify-payment',
            
            init() {
                console.log('ğŸ‰ ä»˜è²»æˆåŠŸé é¢è¼‰å…¥');
                this.getPaymentInfo();
                this.verifyPayment();
            },

            // å¾ URL å–å¾—ä»˜æ¬¾è³‡è¨Š
            getPaymentInfo() {
                const urlParams = new URLSearchParams(window.location.search);
                
                return {
                    // ç¶ ç•Œ ECPay å›å‚³åƒæ•¸
                    merchantTradeNo: urlParams.get('MerchantTradeNo'),  // è¨‚å–®ç·¨è™Ÿ
                    tradeNo: urlParams.get('TradeNo'),                  // ç¶ ç•Œäº¤æ˜“ç·¨è™Ÿ
                    paymentType: urlParams.get('PaymentType'),          // ä»˜æ¬¾æ–¹å¼
                    tradeAmt: urlParams.get('TradeAmt'),                // äº¤æ˜“é‡‘é¡
                    paymentDate: urlParams.get('PaymentDate'),          // ä»˜æ¬¾æ™‚é–“
                    rtnCode: urlParams.get('RtnCode'),                  // äº¤æ˜“ç‹€æ…‹ (1=æˆåŠŸ)
                    rtnMsg: urlParams.get('RtnMsg'),                    // äº¤æ˜“è¨Šæ¯
                    
                    // NewebPay å›å‚³åƒæ•¸ (å‚™ç”¨)
                    status: urlParams.get('Status'),                    // ä»˜æ¬¾ç‹€æ…‹
                    message: urlParams.get('Message'),                  // ä»˜æ¬¾è¨Šæ¯
                    result: urlParams.get('Result'),                    // ä»˜æ¬¾çµæœ
                    
                    // è‡ªè¨‚åƒæ•¸
                    userId: urlParams.get('userId'),                    // ç”¨æˆ¶ ID
                    planType: urlParams.get('planType'),                // æ–¹æ¡ˆé¡å‹ (monthly/yearly)
                    customField1: urlParams.get('CustomField1'),        // è‡ªè¨‚æ¬„ä½
                };
            },

            // é©—è­‰ä»˜æ¬¾ä¸¦æ›´æ–°æœƒå“¡ç­‰ç´š
            async verifyPayment() {
                try {
                    const paymentInfo = this.getPaymentInfo();
                    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
                    const lineData = JSON.parse(localStorage.getItem('ipas_user_data') || '{}');
                    
                    // å–å¾—ç”¨æˆ¶ ID (å„ªå…ˆä½¿ç”¨ URL åƒæ•¸,å†å¾ localStorage å–å¾—)
                    const userId = paymentInfo.userId || 
                                   userData.line_user_id || 
                                   lineData.userId;

                    if (!userId) {
                        throw new Error('æ‰¾ä¸åˆ°ç”¨æˆ¶ ID');
                    }

                    console.log('ğŸ“¡ ç™¼é€ä»˜æ¬¾é©—è­‰è«‹æ±‚...', {
                        userId: userId,
                        paymentInfo: paymentInfo
                    });

                    // å‘¼å« n8n Webhook é©—è­‰ä»˜æ¬¾
                    const response = await fetch(this.N8N_VERIFY_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userId,
                            merchantTradeNo: paymentInfo.merchantTradeNo,
                            tradeNo: paymentInfo.tradeNo,
                            tradeAmt: paymentInfo.tradeAmt,
                            rtnCode: paymentInfo.rtnCode,
                            planType: paymentInfo.planType || 'monthly',
                            paymentDate: paymentInfo.paymentDate || new Date().toISOString(),
                            paymentType: paymentInfo.paymentType || 'unknown'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('é©—è­‰è«‹æ±‚å¤±æ•—');
                    }

                    const result = await response.json();
                    console.log('âœ… é©—è­‰æˆåŠŸ:', result);

                    // æ›´æ–° localStorage ä¸­çš„æœƒå“¡ç­‰ç´š
                    if (userData.line_user_id) {
                        userData.member_level = 'ä»˜è²»æœƒå“¡';
                        localStorage.setItem('user_data', JSON.stringify(userData));
                    }
                    
                    if (lineData.userId) {
                        lineData.memberLevel = 'ä»˜è²»æœƒå“¡';
                        localStorage.setItem('ipas_user_data', JSON.stringify(lineData));
                    }

                    // é¡¯ç¤ºæˆåŠŸç•«é¢
                    this.showSuccess(result, paymentInfo);

                } catch (error) {
                    console.error('âŒ ä»˜æ¬¾é©—è­‰å¤±æ•—:', error);
                    this.showError(error.message);
                }
            },

            // é¡¯ç¤ºæˆåŠŸç•«é¢
            showSuccess(result, paymentInfo) {
                document.getElementById('verifying-section').style.display = 'none';
                document.getElementById('success-section').style.display = 'block';

                // å¡«å…¥æœƒå“¡æ–¹æ¡ˆè³‡è¨Š
                const planNames = {
                    'monthly': 'æœˆè²»æœƒå“¡ ($199/æœˆ)',
                    'yearly': 'å¹´è²»æœƒå“¡ ($1,999/å¹´)'
                };
                
                const expiryDate = new Date();
                if (paymentInfo.planType === 'yearly') {
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                } else {
                    expiryDate.setMonth(expiryDate.getMonth() + 1);
                }

                document.getElementById('plan-type').textContent = planNames[paymentInfo.planType] || 'æœˆè²»æœƒå“¡';
                document.getElementById('expiry-date').textContent = expiryDate.toLocaleDateString('zh-TW');
                document.getElementById('order-id').textContent = paymentInfo.merchantTradeNo || 'ç³»çµ±è™•ç†ä¸­';

                // é–‹å§‹å€’æ•¸è¨ˆæ™‚
                this.startCountdown();
            },

            // é¡¯ç¤ºéŒ¯èª¤ç•«é¢
            showError(errorMessage) {
                document.getElementById('verifying-section').style.display = 'none';
                document.getElementById('error-section').style.display = 'block';
                document.getElementById('error-message').textContent = errorMessage;
            },

            // å€’æ•¸è¨ˆæ™‚è·³è½‰
            startCountdown() {
                let seconds = 5;
                const countdownElement = document.getElementById('countdown');

                const timer = setInterval(() => {
                    seconds--;
                    countdownElement.textContent = seconds;

                    if (seconds <= 0) {
                        clearInterval(timer);
                        this.redirectToHome();
                    }
                }, 1000);
            },

            // è·³è½‰å›é¦–é 
            redirectToHome() {
                window.location.href = 'web.html';
            }
        };

        // å…¨åŸŸå‡½æ•¸ä¾›æŒ‰éˆ•ä½¿ç”¨
        function redirectToHome() {
            PaymentSuccessHandler.redirectToHome();
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            PaymentSuccessHandler.init();
        });
    </script>
</body>
</html>
