<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«å°ˆæ¥­ç·´ç¿’ç³»çµ±</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            padding: 10px;
            padding-bottom: 0;
            min-height: 100vh;
            margin-bottom: 120px;
            overflow-x: hidden;
        }
        
        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            margin-bottom: 130px;
            max-width: 95%;
            width: 100%;
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 250px);
            padding-bottom: 40px;
        }
        
        .quiz-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .quiz-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }
        
        .quiz-status {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 3;
        }
        
        .quiz-status.active {
            background: #28a745;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .database-selector {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .database-selector.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(70%);
            position: relative;
        }
        
        .database-selector.disabled::after {
            content: 'ğŸ”’ æ¸¬é©—é€²è¡Œä¸­ï¼Œç„¡æ³•åˆ‡æ›é¡Œåº«';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 10;
        }
        
        .database-card {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .database-card:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-3px);
        }
        
        .database-card.selected {
            background: rgba(255, 255, 255, 0.4);
            border-color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .quiz-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin: 20px;
            margin-bottom: 40px;
        }
        
        .option-label {
            display: block;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            position: relative;
            overflow: hidden;
        }
        
        .option-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .option-label:hover {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-color: #2196f3;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .option-label:hover::before {
            left: 100%;
        }
        
        .option-input:checked + .option-label {
            background: linear-gradient(145deg, #c8e6c9, #a5d6a7);
            border-color: #4caf50;
            color: #2e7d32;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        
        .option-input:checked + .option-label::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #4caf50;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            animation: checkmark 0.3s ease-in-out;
        }
        
        @keyframes checkmark {
            0% { transform: translateY(-50%) scale(0); }
            50% { transform: translateY(-50%) scale(1.2); }
            100% { transform: translateY(-50%) scale(1); }
        }
        
        .option-input {
            display: none;
        }
        
        .explanation-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 5px solid #007bff;
            padding: 25px;
            margin-top: 20px;
            border-radius: 12px;
            min-height: 150px;
            max-height: 500px;
            overflow-y: auto;
            word-wrap: break-word;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .explanation-box::-webkit-scrollbar {
            width: 8px;
        }
        
        .explanation-box::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        .explanation-box::-webkit-scrollbar-thumb {
            background: #007bff;
            border-radius: 5px;
        }
        
        .explanation-box::-webkit-scrollbar-thumb:hover {
            background: #0056b3;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 249, 250, 0.98));
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1040;
            padding: 20px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 0.85rem;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .progress {
            height: 12px;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
        }
        
        .badge-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-size: 0.9rem;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 5px;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FF5722;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 25px;
        }
        
        .timer.warning {
            color: #dc3545;
            animation: blink 1s infinite;
            background: rgba(255, 0, 0, 0.1);
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .correct {
            color: #198754;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .incorrect {
            color: #dc3545;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .highlight {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 1rem;
            line-height: 1.6;
            border-left: 4px solid #ffc107;
        }
        
        .nav-brand {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white !important;
            font-weight: bold;
            border-radius: 10px;
            padding: 8px 16px !important;
        }
        
        .settings-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .settings-panel.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .mode-btn {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-weight: 600;
        }
        
        .mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .back-to-selection {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .back-to-selection:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }
        
        .loader {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* è¤‡ç¿’æ¨¡å¼é¸æ“‡æ¨£å¼ */
        .review-modes {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }

        .review-mode-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .review-mode-item:hover {
            background: rgba(40, 167, 69, 0.1);
            transform: translateX(5px);
        }

        .review-mode-item.selected {
            background: #28a745;
            color: white;
        }

        /* å•å·ç›¸é—œæ¨£å¼ */
        .survey-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 900px;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .survey-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .survey-content {
            padding: 40px;
        }

        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 30px 0 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-card {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .question-card:hover {
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
        }

        .question-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .survey-form-check {
            margin-bottom: 12px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .survey-form-check:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .survey-form-check-input:checked ~ .survey-form-check-label {
            color: #667eea;
            font-weight: 600;
        }

        .rating-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .rating-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            min-width: 40px;
        }

        .rating-item:hover {
            background: #e3f2fd;
            transform: scale(1.1);
        }

        .rating-item input[type="radio"] {
            display: none;
        }

        .rating-item input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .checkbox-item input:checked ~ label {
            color: #667eea;
            font-weight: 600;
        }

        .survey-text-input {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .survey-text-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        .submit-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
            margin-top: 40px;
            border-radius: 15px;
        }

        .btn-submit {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .reward-box {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .required-indicator {
            color: #dc3545;
            font-weight: bold;
        }

        .progress-indicator {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            body {
                margin-bottom: 130px;
            }
            
            .main-container {
                margin: 5px auto;
                margin-bottom: 140px;
                border-radius: 15px;
                max-width: 98%;
                padding-bottom: 50px;
            }
            
            .quiz-header {
                padding: 15px;
                border-radius: 15px 15px 0 0;
            }
            
            .database-selector, .quiz-container, .settings-panel {
                margin: 10px;
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .database-card {
                padding: 15px;
                margin: 8px 0;
            }

            .survey-content {
                padding: 20px;
            }
            
            .checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            .rating-container {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
    </style>

    <script>
        // è¼‰å…¥é¡Œåº«è³‡æ–™
        let quizData = {
            'generative-ai': [],
            'ipas': []
        };

        async function loadQuizDatabases() {
            try {
                console.log('ğŸ” é–‹å§‹è¼‰å…¥é¡Œåº«...');
                
                // è¼‰å…¥ç”Ÿæˆå¼AIé¡Œåº«
                try {
                    const response1 = await fetch('./æ¨¡æ“¬è€ƒé¡Œ.json');
                    if (response1.ok) {
                        const data1 = await response1.json();
                        if (Array.isArray(data1) && data1.length > 0) {
                            quizData['generative-ai'] = data1;
                            console.log('âœ… ç”Ÿæˆå¼AIé¡Œåº«å·²è¼‰å…¥:', quizData['generative-ai'].length + 'é¡Œ');
                        } else {
                            throw new Error('é¡Œåº«æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º');
                        }
                    } else {
                        throw new Error(`HTTP ${response1.status}`);
                    }
                } catch (error) {
                    console.warn('âš ï¸ ç”Ÿæˆå¼AIé¡Œåº«è¼‰å…¥å¤±æ•—:', error.message);
                    quizData['generative-ai'] = [];
                }
                
                // è¼‰å…¥iPASé¡Œåº«
                try {
                    const response2 = await fetch('./æ‡‰ç”¨æ¨¡æ“¬è€ƒé¡Œ.json');
                    if (response2.ok) {
                        const data2 = await response2.json();
                        if (Array.isArray(data2) && data2.length > 0) {
                            quizData['ipas'] = data2;
                            console.log('âœ… iPASé¡Œåº«å·²è¼‰å…¥:', quizData['ipas'].length + 'é¡Œ');
                        } else {
                            throw new Error('é¡Œåº«æ ¼å¼éŒ¯èª¤æˆ–ç‚ºç©º');
                        }
                    } else {
                        throw new Error(`HTTP ${response2.status}`);
                    }
                } catch (error) {
                    console.warn('âš ï¸ iPASé¡Œåº«è¼‰å…¥å¤±æ•—:', error.message);
                    quizData['ipas'] = [];
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦ç”Ÿæˆç¤ºä¾‹æ•¸æ“š
                if (quizData['ipas'].length === 0 && quizData['generative-ai'].length === 0) {
                    console.log('ğŸ“ å…©å€‹é¡Œåº«éƒ½è¼‰å…¥å¤±æ•—ï¼Œç”Ÿæˆç¤ºä¾‹é¡Œåº«...');
                    quizData['ipas'] = generateSampleQuestions();
                    quizData['generative-ai'] = generateSampleAIQuestions();
                    
                    // é¡¯ç¤ºæç¤ºè¨Šæ¯
                    setTimeout(() => {
                        if (typeof iPASQuizApp !== 'undefined' && iPASQuizApp.showAlert) {
                            iPASQuizApp.showAlert('é¡Œåº«æª”æ¡ˆæœªæ‰¾åˆ°ï¼Œå·²è¼‰å…¥ç¤ºä¾‹é¡Œç›®ä¾›æ¸¬è©¦ï¼\nè«‹ç¢ºä¿ æ¨¡æ“¬è€ƒé¡Œ.json å’Œ æ‡‰ç”¨æ¨¡æ“¬è€ƒé¡Œ.json åœ¨æ­£ç¢ºä½ç½®ã€‚', 'warning');
                        } else {
                            alert('é¡Œåº«æª”æ¡ˆæœªæ‰¾åˆ°ï¼Œå·²è¼‰å…¥ç¤ºä¾‹é¡Œç›®ä¾›æ¸¬è©¦ï¼\nè«‹ç¢ºä¿ æ¨¡æ“¬è€ƒé¡Œ.json å’Œ æ‡‰ç”¨æ¨¡æ“¬è€ƒé¡Œ.json åœ¨æ­£ç¢ºä½ç½®ã€‚');
                        }
                    }, 1000);
                } else if (quizData['ipas'].length === 0) {
                    console.log('ğŸ“ iPASé¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œç”Ÿæˆç¤ºä¾‹iPASé¡Œåº«...');
                    quizData['ipas'] = generateSampleQuestions();
                } else if (quizData['generative-ai'].length === 0) {
                    console.log('ğŸ“ ç”Ÿæˆå¼AIé¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œç”Ÿæˆç¤ºä¾‹AIé¡Œåº«...');
                    quizData['generative-ai'] = generateSampleAIQuestions();
                }
                
                console.log('ğŸ“š é¡Œåº«è¼‰å…¥å®Œæˆ');
                console.log('ğŸ“Š è¼‰å…¥ç‹€æ…‹:', {
                    'iPASé¡Œåº«': quizData['ipas'].length + 'é¡Œ',
                    'ç”Ÿæˆå¼AIé¡Œåº«': quizData['generative-ai'].length + 'é¡Œ'
                });
                
            } catch (error) {
                console.error('âŒ é¡Œåº«è¼‰å…¥ç™¼ç”Ÿåš´é‡éŒ¯èª¤:', error);
                // ç¢ºä¿è‡³å°‘æœ‰ä¸€äº›é¡Œç›®å¯ç”¨
                quizData['ipas'] = generateSampleQuestions();
                quizData['generative-ai'] = generateSampleAIQuestions();
                
                setTimeout(() => {
                    if (typeof iPASQuizApp !== 'undefined' && iPASQuizApp.showAlert) {
                        iPASQuizApp.showAlert('é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œå·²è¼‰å…¥ç¤ºä¾‹é¡Œç›®ï¼', 'error');
                    } else {
                        alert('é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œå·²è¼‰å…¥ç¤ºä¾‹é¡Œç›®ï¼');
                    }
                }, 1000);
            }
        }

        // ç”Ÿæˆç¤ºä¾‹iPASé¡Œç›®
        function generateSampleQuestions() {
            return [
                {
                    question: "æ ¹æ“šç¶“æ¿Ÿéƒ¨iPASèªè­‰æ¨™æº–ï¼ŒAIæ‡‰ç”¨è¦åŠƒå¸«éœ€è¦å…·å‚™å“ªé …æ ¸å¿ƒèƒ½åŠ›ï¼Ÿ",
                    options: [
                        "ç¨‹å¼è¨­è¨ˆèˆ‡æ¼”ç®—æ³•é–‹ç™¼",
                        "AIæŠ€è¡“æ‡‰ç”¨èˆ‡å•†æ¥­åƒ¹å€¼è©•ä¼°",
                        "ç¡¬é«”è¨­å‚™ç¶­è­·èˆ‡ç®¡ç†",
                        "è³‡æ–™åº«ç®¡ç†èˆ‡ç¶²è·¯å®‰å…¨"
                    ],
                    correct_answer_letter: "B",
                    correct_answer_index: 1,
                    explanation: "AIæ‡‰ç”¨è¦åŠƒå¸«ä¸»è¦è² è²¬è©•ä¼°AIæŠ€è¡“çš„å•†æ¥­æ‡‰ç”¨åƒ¹å€¼ï¼Œè¦åŠƒAIå°ˆæ¡ˆçš„å¯¦æ–½ç­–ç•¥ï¼Œè€Œéç´”æŠ€è¡“é–‹ç™¼å·¥ä½œã€‚",
                    topic: "AIæ‡‰ç”¨è¦åŠƒ",
                    subtopic: "æ ¸å¿ƒèƒ½åŠ›"
                },
                {
                    question: "åœ¨AIå°ˆæ¡ˆè¦åŠƒéšæ®µï¼Œä»¥ä¸‹å“ªå€‹æ­¥é©Ÿæœ€ç‚ºé‡è¦ï¼Ÿ",
                    options: [
                        "é¸æ“‡æœ€å…ˆé€²çš„AIæŠ€è¡“",
                        "ç¢ºä¿å……è¶³çš„ç¡¬é«”è³‡æº",
                        "æ˜ç¢ºå®šç¾©å•é¡Œèˆ‡ç›®æ¨™",
                        "æ‹›å‹Ÿæ›´å¤šæŠ€è¡“äººå“¡"
                    ],
                    correct_answer_letter: "C",
                    correct_answer_index: 2,
                    explanation: "æ˜ç¢ºå®šç¾©å•é¡Œèˆ‡ç›®æ¨™æ˜¯AIå°ˆæ¡ˆæˆåŠŸçš„åŸºç¤ï¼Œåªæœ‰æ¸…æ¥šäº†è§£è¦è§£æ±ºä»€éº¼å•é¡Œï¼Œæ‰èƒ½é¸æ“‡é©åˆçš„æŠ€è¡“æ–¹æ¡ˆã€‚",
                    topic: "å°ˆæ¡ˆç®¡ç†",
                    subtopic: "éœ€æ±‚åˆ†æ"
                }
            ];
        }

        // ç”Ÿæˆç¤ºä¾‹ç”Ÿæˆå¼AIé¡Œç›®
        function generateSampleAIQuestions() {
            return [
                {
                    question: "ç”Ÿæˆå¼AIçš„ä¸»è¦ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ",
                    options: [
                        "åªèƒ½åˆ†æç¾æœ‰è³‡æ–™",
                        "èƒ½å¤ å‰µé€ æ–°çš„å…§å®¹æˆ–è³‡æ–™",
                        "åªèƒ½è™•ç†æ•¸å€¼å‹è³‡æ–™",
                        "åªèƒ½åŸ·è¡Œåˆ†é¡ä»»å‹™"
                    ],
                    correct_answer_letter: "B",
                    correct_answer_index: 1,
                    explanation: "ç”Ÿæˆå¼AIçš„æ ¸å¿ƒç‰¹å¾µæ˜¯èƒ½å¤ å­¸ç¿’è³‡æ–™çš„åˆ†å¸ƒä¸¦ç”Ÿæˆæ–°çš„ã€é¡ä¼¼çš„å…§å®¹ï¼Œå¦‚æ–‡å­—ã€åœ–åƒã€éŸ³æ¨‚ç­‰ã€‚",
                    topic: "ç”Ÿæˆå¼AIåŸºç¤",
                    subtopic: "åŸºæœ¬æ¦‚å¿µ"
                }
            ];
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥é¡Œåº«
        document.addEventListener('DOMContentLoaded', loadQuizDatabases);
    </script>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand nav-brand" href="#">
                <i class="fas fa-graduation-cap me-2"></i>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="save-btn">
                            <i class="fas fa-save me-1"></i>å„²å­˜é€²åº¦
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="export-btn">
                            <i class="fas fa-download me-1"></i>åŒ¯å‡ºéŒ¯é¡Œ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="stats-btn">
                            <i class="fas fa-chart-bar me-1"></i>å­¸ç¿’çµ±è¨ˆ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="help-btn">
                            <i class="fas fa-question-circle me-1"></i>ä½¿ç”¨èªªæ˜
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div style="height: 70px;"></div> <!-- å°èˆªæ¬„é–“è· -->

    <div class="main-container">
        <!-- æ¸¬é©—ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
        <div id="quiz-status" class="quiz-status" style="display: none;">
            <i class="fas fa-lock me-1"></i>æ¸¬é©—é€²è¡Œä¸­
        </div>
        
        <div class="quiz-header">
            <h1><i class="fas fa-brain me-3"></i>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«å°ˆæ¥­ç·´ç¿’ç³»çµ±</h1>
            <p class="mb-0">ç¶“æ¿Ÿéƒ¨ç”¢æ¥­äººæ‰èƒ½åŠ›é‘‘å®š - è€ƒè©¦è¡åˆºå°ˆç”¨</p>
        </div>
        
        <!-- é¡Œåº«é¸æ“‡å€ -->
        <div class="database-selector" id="database-selector">
            <h3 class="mb-4"><i class="fas fa-database me-2"></i>é¸æ“‡ç·´ç¿’é¡Œåº«</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="database-card" data-type="ipas">
                        <div class="text-center">
                            <i class="fas fa-star fa-3x mb-3" style="color: #ffd700;"></i>
                            <h5>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«</h5>
                            <p class="mb-2">ç¶“æ¿Ÿéƒ¨ç”¢æ¥­äººæ‰èƒ½åŠ›é‘‘å®š</p>
                            <small>â­ ä¸»è¦è€ƒè©¦é¡Œåº« - é‡é»ç·´ç¿’</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="database-card" data-type="generative-ai">
                        <div class="text-center">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <h5>ç”Ÿæˆå¼AIèªè­‰</h5>
                            <p class="mb-2">è³‡ç­–æœƒç”Ÿæˆå¼AIèƒ½åŠ›èªè­‰</p>
                            <small>è¼”åŠ©ç·´ç¿’ - è£œå¼·åŸºç¤çŸ¥è­˜</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¨­å®šé¢æ¿ -->
        <div id="settings-panel" class="settings-panel">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>æ¸¬é©—è¨­å®š</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-list-ol me-2 text-primary"></i>é¡Œç›®æ•¸é‡
                            </label>
                            <select id="question-count" class="form-select">
                                <option value="10">10é¡Œ - å¿«é€Ÿç·´ç¿’</option>
                                <option value="20">20é¡Œ - æ¨™æº–ç·´ç¿’</option>
                                <option value="40">40é¡Œ - åŠ å¼·ç·´ç¿’</option>
                                <option value="60" selected>60é¡Œ - iPASæ¨™æº–</option>
                                <option value="80">80é¡Œ - å®Œæ•´æ¸¬é©—</option>
                            </select>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-play-circle me-2 text-success"></i>ç·´ç¿’æ¨¡å¼
                            </label>
                            <div class="d-flex flex-wrap gap-1">
                                <button class="mode-btn active" data-mode="practice">
                                    <i class="fas fa-book me-1"></i>ç·´ç¿’æ¨¡å¼
                                </button>
                                <button class="mode-btn" data-mode="exam">
                                    <i class="fas fa-clock me-1"></i>æ¨¡æ“¬è€ƒè©¦
                                </button>
                            </div>
                            <!-- è¤‡ç¿’æ¨¡å¼é¸æ“‡å€ -->
                            <div class="review-modes mt-2" id="review-modes-section" style="display: none;">
                                <h6 class="mb-2"><i class="fas fa-redo me-2"></i>è¤‡ç¿’æ¨¡å¼é¸æ“‡</h6>
                                <div class="review-mode-item" data-review-mode="wrong" id="review-wrong-mode">
                                    <i class="fas fa-times-circle me-2"></i>éŒ¯é¡Œè¤‡ç¿’
                                    <small class="d-block text-muted">è¤‡ç¿’ä¹‹å‰ç­”éŒ¯çš„é¡Œç›®</small>
                                </div>
                                <div class="review-mode-item" data-review-mode="all" id="review-all-mode">
                                    <i class="fas fa-list me-2"></i>å…¨é¡Œè¤‡ç¿’
                                    <small class="d-block text-muted">ç³»çµ±æ€§è¤‡ç¿’æ‰€æœ‰é¡Œç›®</small>
                                </div>
                                <div class="review-mode-item" data-review-mode="topic" id="review-topic-mode">
                                    <i class="fas fa-tags me-2"></i>ä¸»é¡Œè¤‡ç¿’
                                    <small class="d-block text-muted">æŒ‰ä¸»é¡Œåˆ†é¡è¤‡ç¿’</small>
                                </div>
                                <div class="review-mode-item" data-review-mode="random" id="review-random-mode">
                                    <i class="fas fa-random me-2"></i>éš¨æ©Ÿè¤‡ç¿’
                                    <small class="d-block text-muted">éš¨æ©Ÿé †åºè¤‡ç¿’</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-lightbulb me-2 text-warning"></i>è§£ææ¨¡å¼
                            </label>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="explanation-mode" id="database-mode" value="database" checked>
                                    <label class="form-check-label" for="database-mode">è³‡æ–™åº«è§£æ</label>
                                </div>
                                <div class="form-check form-check-inline" style="display: none;">
                                    <input class="form-check-input" type="radio" name="explanation-mode" id="ai-mode" value="ai">
                                    <label class="form-check-label" for="ai-mode">AIç”Ÿæˆè§£æ</label>
                                </div>
                            </div>
                            <div id="ai-model-select" class="d-none">
                                <select id="ai-model" class="form-select form-select-sm">
                                    <option value="gpt-4o" selected>GPT-4o (æ¨è–¦)</option>
                                    <option value="claude-3.7-sonnet">Claude 3.7 Sonnet</option>
                                    <option value="grok-3">Grok 3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-rocket me-2 text-danger"></i>æº–å‚™å°±ç·’
                            </label>
                            <button id="start-btn" class="btn btn-danger w-100 mb-2" disabled>
                                <i class="fas fa-play me-2"></i>é–‹å§‹ç·´ç¿’
                            </button>
                            <button id="review-btn-main" class="btn btn-success w-100 mb-2" disabled style="display: none;">
                                <i class="fas fa-redo me-2"></i>é–‹å§‹è¤‡ç¿’
                            </button>
                            <div id="timer" class="timer text-center">
                                <i class="fas fa-clock me-2"></i>è«‹å…ˆé¸æ“‡é¡Œåº«
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å•é¡Œå€åŸŸ -->
        <div id="quiz-container" class="quiz-container d-none">
            <!-- è¿”å›é¸æ“‡æŒ‰éˆ• -->
            <button id="back-to-selection" class="back-to-selection">
                <i class="fas fa-arrow-left me-2"></i>è¿”å›é¡Œåº«é¸æ“‡
            </button>
            
            <div class="progress mb-3">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 id="question-number" class="mb-0">å•é¡Œ 1/60</h5>
                <div class="d-flex gap-2">
                    <span id="database-badge" class="badge-custom">iPASé¡Œåº«</span>
                    <span id="stats-display" class="badge bg-info">å¾—åˆ†: 0/0 (0%)</span>
                </div>
            </div>
            
            <h4 id="question-text" class="mb-4">è¼‰å…¥é¡Œç›®ä¸­...</h4>
            
            <div id="options-container" class="mb-4">
                <!-- é¸é …æœƒåœ¨JavaScriptä¸­å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <div id="explanation-box" class="explanation-box d-none">
                <h5 class="mb-3"><i class="fas fa-lightbulb me-2"></i>ç­”æ¡ˆè§£æ</h5>
                <div id="explanation-content"></div>
                <div class="mt-3">
                    <span id="topic-badge" class="badge bg-secondary me-2"></span>
                    <span id="subtopic-badge" class="badge bg-info"></span>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å°èˆª -->
        <div class="bottom-nav" id="bottom-navigation">
            <div class="container-fluid">
                <div class="row justify-content-between align-items-center">
                    <div class="col-2">
                        <button id="prev-btn" class="btn btn-secondary w-100" disabled>
                            <i class="fas fa-arrow-left me-1"></i> 
                            <span class="d-none d-sm-inline">ä¸Šä¸€é¡Œ</span>
                        </button>
                    </div>
                    <div class="col-2">
                        <button id="submit-btn" class="btn btn-primary w-100" disabled>
                            <i class="fas fa-check me-1"></i> 
                            <span class="d-none d-sm-inline">æäº¤</span>
                        </button>
                    </div>
                    <div class="col-2">
                        <button id="next-btn" class="btn btn-warning w-100" disabled>
                            <span class="d-none d-sm-inline">ä¸‹ä¸€é¡Œ</span>
                            <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                    <div class="col-2">
                        <button id="finish-btn" class="btn btn-success w-100" disabled>
                            <i class="fas fa-flag-checkered me-1"></i> 
                            <span class="d-none d-sm-inline">å®Œæˆ</span>
                        </button>
                    </div>
                    <div class="col-2">
                        <button id="explanation-btn" class="btn btn-info w-100" disabled>
                            <i class="fas fa-lightbulb me-1"></i> 
                            <span class="d-none d-sm-inline">æŸ¥çœ‹è§£æ</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ…‹æ¡† -->
    <!-- æ¸¬é©—çµæœæ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="result-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">æ¸¬é©—çµæœ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="result-content" style="max-height: 70vh; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    <button type="button" class="btn btn-success" id="restart-quiz-btn">
                        <i class="fas fa-redo me-1"></i>é‡æ–°æ¸¬é©—
                    </button>
                    <button type="button" class="btn btn-primary" id="review-wrong-btn">
                        <i class="fas fa-times-circle me-1"></i>è¤‡ç¿’éŒ¯é¡Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆè³‡æ–™æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="stats-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">å­¸ç¿’çµ±è¨ˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="stats-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    <button type="button" class="btn btn-danger" id="reset-stats-btn">é‡ç½®å­¸ç¿’é€²åº¦</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä½¿ç”¨èªªæ˜æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="help-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">iPASè€ƒè©¦æº–å‚™æŒ‡å—</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h5><i class="fas fa-target me-2 text-primary"></i>è€ƒè©¦æº–å‚™ç­–ç•¥</h5>
                    <div class="alert alert-info">
                        <strong>è€ƒè©¦è³‡è¨Šï¼š</strong>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«åˆç´šèªè­‰ï¼Œå»ºè­°æº–å‚™æ™‚é–“ï¼š4-6é€±
                    </div>
                    
                    <h6>ğŸ“š è¤‡ç¿’æ¨¡å¼ä½¿ç”¨å»ºè­°</h6>
                    <ul>
                        <li><strong>éŒ¯é¡Œè¤‡ç¿’ï¼š</strong>é‡é»æ”»å…‹è–„å¼±ç’°ç¯€</li>
                        <li><strong>å…¨é¡Œè¤‡ç¿’ï¼š</strong>ç³»çµ±æ€§å›é¡§æ‰€æœ‰å…§å®¹</li>
                        <li><strong>ä¸»é¡Œè¤‡ç¿’ï¼š</strong>é‡å°ç‰¹å®šé ˜åŸŸåŠ å¼·</li>
                        <li><strong>éš¨æ©Ÿè¤‡ç¿’ï¼š</strong>æ¨¡æ“¬è€ƒè©¦éš¨æ©Ÿå‡ºé¡Œ</li>
                    </ul>
                    
                    <h6>ğŸ“‹ ç·´ç¿’æ¨¡å¼å»ºè­°</h6>
                    <ul>
                        <li><strong>æ¯æ—¥ç·´ç¿’ï¼š</strong>20-40é¡Œç¶­æŒæ‰‹æ„Ÿ</li>
                        <li><strong>é€±æœ«æ¨¡æ“¬ï¼š</strong>60é¡Œå®Œæ•´æ¸¬é©—</li>
                        <li><strong>è€ƒå‰è¡åˆºï¼š</strong>éŒ¯é¡Œè¤‡ç¿’æ¨¡å¼</li>
                    </ul>
                    
                    <h6>ğŸ¯ é‡é»é¡Œå‹</h6>
                    <ul>
                        <li>AIæŠ€è¡“æ‡‰ç”¨èˆ‡å•†æ¥­åƒ¹å€¼è©•ä¼°</li>
                        <li>å°ˆæ¡ˆè¦åŠƒèˆ‡ç®¡ç†æµç¨‹</li>
                        <li>æ•¸æ“šåˆ†æèˆ‡æ¨¡å‹è©•ä¼°</li>
                        <li>å€«ç†èˆ‡é¢¨éšªç®¡ç†</li>
                    </ul>
                    
                    <h6>â±ï¸ æ¨¡æ“¬è€ƒè©¦å»ºè­°</h6>
                    <ul>
                        <li>é¸æ“‡60é¡Œæ¨™æº–æ¨¡å¼</li>
                        <li>åš´æ ¼æ§åˆ¶ç­”é¡Œæ™‚é–“</li>
                        <li>ç›®æ¨™æ­£ç¢ºç‡ï¼š70%ä»¥ä¸Š</li>
                    </ul>
                    
                    <h6>ğŸ“Š ä½¿ç”¨çµ±è¨ˆåŠŸèƒ½</h6>
                    <ul>
                        <li>å®šæœŸæª¢æŸ¥å­¸ç¿’çµ±è¨ˆ</li>
                        <li>é‡é»é—œæ³¨è–„å¼±ä¸»é¡Œ</li>
                        <li>åŒ¯å‡ºéŒ¯é¡Œé€²è¡Œç´™æœ¬è¤‡ç¿’</li>
                    </ul>
                    <ul>
                        <li>é–‹ç™¼è€…ï¼šZN Studio</li>
                        <li>ç‰ˆæœ¬ï¼š2.1.0 (å¤–éƒ¨å•å·ç‰ˆ)</li>
                        <li>æœ¬ç³»çµ±ç”±æœ¬äººç¨ç«‹è¨­è¨ˆèˆ‡é–‹ç™¼ï¼Œå°ˆç‚ºiPAS AIæ‡‰ç”¨è¦åŠƒå¸«è€ƒè©¦è¨­è¨ˆ</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è¼‰é®ç½© -->
    <div id="loading-overlay" class="overlay d-none">
        <div class="loader"></div>
        <div id="loading-text" class="loading-text">è™•ç†ä¸­...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨åŸŸç‹€æ…‹ç®¡ç†
        const iPASQuizApp = {
            // æ‡‰ç”¨ç‹€æ…‹
            state: {
                isQuizActive: false,
                selectedDatabase: null,
                currentMode: 'practice',
                selectedReviewMode: null,
                explanationMode: 'database',
                selectedAIModel: 'gpt-4o',
                questions: [],
                currentQuestionIndex: 0,
                userAnswers: {},
                questionMapping: {},
                score: 0,
                wrongQuestions: [],
                startTime: null,
                isTimerRunning: false,
                examDuration: 90,
                timerId: null,
                userData: null,
                
                // === æ–°å¢ï¼šå•å·ç›¸é—œç‹€æ…‹ ===
                surveyCompleted: localStorage.getItem('iPAS_survey_completed') === 'true',
                surveyData: null,
                currentTestResults: null,
                webhookUrl: 'https://nickleo9.zeabur.app/webhook/ipas-survey'
            },
            
            // DOM å…ƒç´ 
            elements: {
                databaseSelector: document.getElementById('database-selector'),
                databaseCards: document.querySelectorAll('.database-card'),
                settingsPanel: document.getElementById('settings-panel'),
                quizContainer: document.getElementById('quiz-container'),
                startBtn: document.getElementById('start-btn'),
                reviewBtnMain: document.getElementById('review-btn-main'),
                reviewModesSection: document.getElementById('review-modes-section'),
                backBtn: document.getElementById('back-to-selection'),
                prevBtn: document.getElementById('prev-btn'),
                submitBtn: document.getElementById('submit-btn'),
                nextBtn: document.getElementById('next-btn'),
                finishBtn: document.getElementById('finish-btn'),
                explanationBtn: document.getElementById('explanation-btn'),
                quizStatus: document.getElementById('quiz-status'),
                timerElement: document.getElementById('timer'),
                questionNumber: document.getElementById('question-number'),
                questionText: document.getElementById('question-text'),
                optionsContainer: document.getElementById('options-container'),
                explanationBox: document.getElementById('explanation-box'),
                explanationContent: document.getElementById('explanation-content'),
                progressBar: document.getElementById('progress-bar'),
                statsDisplay: document.getElementById('stats-display'),
                topicBadge: document.getElementById('topic-badge'),
                subtopicBadge: document.getElementById('subtopic-badge'),
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingText: document.getElementById('loading-text')
            },
            
            // æ¨¡æ…‹æ¡†
            modals: {
                result: new bootstrap.Modal(document.getElementById('result-modal')),
                stats: new bootstrap.Modal(document.getElementById('stats-modal')),
                help: new bootstrap.Modal(document.getElementById('help-modal'))
            },
            
            // åˆå§‹åŒ–
            init() {
                this.state.userData = this.loadUserData();
                this.attachEventListeners();
                this.updateReviewButtonState();
                console.log('ğŸš€ iPAS AIæ‡‰ç”¨è¦åŠƒå¸«ç·´ç¿’ç³»çµ±å·²åˆå§‹åŒ– (v2.1.0 å¤–éƒ¨å•å·ç‰ˆ)');
            },
            
            // è¼‰å…¥ä½¿ç”¨è€…æ•¸æ“š
            loadUserData() {
                try {
                    const data = localStorage.getItem('iPASQuizUserData');
                    return data ? JSON.parse(data) : {
                        correct: [],
                        incorrect: [],
                        history: [],
                        databaseStats: {}
                    };
                } catch (error) {
                    console.error('è¼‰å…¥ä½¿ç”¨è€…æ•¸æ“šéŒ¯èª¤:', error);
                    return { correct: [], incorrect: [], history: [], databaseStats: {} };
                }
            },
            
            // ä¿å­˜ä½¿ç”¨è€…æ•¸æ“š
            saveUserData(showMessage = false) {
                try {
                    localStorage.setItem('iPASQuizUserData', JSON.stringify(this.state.userData));
                    if (showMessage) this.showAlert('å­¸ç¿’æ•¸æ“šå·²å„²å­˜', 'success');
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜ä½¿ç”¨è€…æ•¸æ“šéŒ¯èª¤:', error);
                    if (showMessage) this.showAlert('å„²å­˜å¤±æ•—: ' + error.message, 'error');
                    return false;
                }
            },
            
            // äº‹ä»¶ç›£è½å™¨
            attachEventListeners() {
                this.elements.databaseCards.forEach(card => card.addEventListener('click', (e) => {
                    if (this.state.isQuizActive) {
                        this.showAlert('æ¸¬é©—é€²è¡Œä¸­ï¼Œç„¡æ³•åˆ‡æ›é¡Œåº«ï¼', 'warning');
                        return;
                    }
                    this.selectDatabase(card.dataset.type);
                }));
                
                this.elements.startBtn.addEventListener('click', () => this.startQuiz());
                this.elements.reviewBtnMain.addEventListener('click', () => this.startReview());
                this.elements.backBtn.addEventListener('click', () => this.backToSelection());
                this.elements.prevBtn.addEventListener('click', () => this.prevQuestion());
                this.elements.submitBtn.addEventListener('click', () => this.submitAnswer());
                this.elements.nextBtn.addEventListener('click', () => this.nextQuestion());
                this.elements.finishBtn.addEventListener('click', () => this.finishQuiz());
                this.elements.explanationBtn.addEventListener('click', () => this.showCurrentExplanation());
                
                document.querySelectorAll('.review-mode-item').forEach(item => item.addEventListener('click', (e) => {
                    if (this.state.isQuizActive) {
                        this.showAlert('æ¸¬é©—é€²è¡Œä¸­ï¼Œç„¡æ³•æ›´æ”¹è¤‡ç¿’æ¨¡å¼ï¼', 'warning');
                        return;
                    }
                    this.selectReviewMode(item.dataset.reviewMode);
                }));
                
                document.getElementById('save-btn').addEventListener('click', () => this.saveUserData(true));
                document.getElementById('export-btn').addEventListener('click', () => this.exportWrongQuestions());
                document.getElementById('stats-btn').addEventListener('click', () => this.showStatistics());
                document.getElementById('help-btn').addEventListener('click', () => this.modals.help.show());
                
                document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => {
                    if (this.state.isQuizActive) {
                        this.showAlert('æ¸¬é©—é€²è¡Œä¸­ï¼Œç„¡æ³•æ›´æ”¹æ¨¡å¼ï¼', 'warning');
                        return;
                    }
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.state.currentMode = btn.dataset.mode;
                    this.updateModeUI();
                }));
                
                document.querySelectorAll('[name="explanation-mode"]').forEach(radio => radio.addEventListener('change', (e) => {
                    this.state.explanationMode = e.target.value;
                    document.getElementById('ai-model-select').classList.toggle('d-none', this.state.explanationMode !== 'ai');
                }));
                
                document.getElementById('ai-model').addEventListener('change', (e) => { this.state.selectedAIModel = e.target.value; });
                
                document.getElementById('review-wrong-btn').addEventListener('click', () => this.reviewWrongQuestions());
                document.getElementById('restart-quiz-btn').addEventListener('click', () => this.restartQuiz());
                document.getElementById('reset-stats-btn').addEventListener('click', () => this.resetProgress());
                
                window.addEventListener('beforeunload', () => this.saveUserData(false));
            },
            
            // é¸æ“‡è¤‡ç¿’æ¨¡å¼
            selectReviewMode(mode) {
                document.querySelectorAll('.review-mode-item').forEach(item => item.classList.remove('selected'));
                const selectedItem = document.querySelector(`[data-review-mode="${mode}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                    this.state.selectedReviewMode = mode;
                    this.updateReviewButtonState();
                    console.log(`âœ… å·²é¸æ“‡è¤‡ç¿’æ¨¡å¼: ${mode}`);
                }
            },
            
            // æ›´æ–°æ¨¡å¼UI
            updateModeUI() {
                if (this.state.currentMode === 'practice' || this.state.currentMode === 'exam') {
                    this.elements.reviewModesSection.style.display = 'none';
                    this.elements.startBtn.style.display = 'block';
                    this.elements.reviewBtnMain.style.display = 'none';
                }
            },
            
            // é–‹å§‹è¤‡ç¿’
            startReview() {
                if (!this.state.selectedDatabase) return this.showAlert('è«‹å…ˆé¸æ“‡é¡Œåº«ï¼', 'warning');
                if (!this.state.selectedReviewMode) return this.showAlert('è«‹é¸æ“‡è¤‡ç¿’æ¨¡å¼ï¼', 'warning');
                
                this.showLoading('æº–å‚™è¤‡ç¿’æ¨¡å¼...');
                this.state.isQuizActive = true;
                this.state.currentMode = 'review';
                this.lockInterface();
                
                setTimeout(() => {
                    if (this.loadReviewQuestions()) {
                        this.state.currentQuestionIndex = 0;
                        this.state.userAnswers = {};
                        this.state.questionMapping = {};
                        this.state.score = 0;
                        this.state.wrongQuestions = [];
                        this.state.startTime = new Date();
                        
                        this.elements.settingsPanel.classList.add('d-none');
                        this.elements.quizContainer.classList.remove('d-none');
                        this.elements.quizStatus.style.display = 'block';
                        this.elements.quizStatus.classList.add('active');
                        this.elements.quizStatus.innerHTML = '<i class="fas fa-redo me-1"></i>è¤‡ç¿’é€²è¡Œä¸­';
                        
                        this.displayQuestion();
                        this.hideLoading();
                        console.log('âœ… è¤‡ç¿’å·²é–‹å§‹');
                    } else {
                        this.hideLoading();
                        this.state.isQuizActive = false;
                        this.unlockInterface();
                    }
                }, 500);
            },
            
            // è¼‰å…¥è¤‡ç¿’é¡Œç›®
            loadReviewQuestions() {
                const currentQuizData = quizData[this.state.selectedDatabase];
                if (!currentQuizData || currentQuizData.length === 0) {
                    this.showAlert(`${this.state.selectedDatabase === 'ipas' ? 'iPAS' : 'ç”Ÿæˆå¼AI'}é¡Œåº«å°šæœªè¼‰å…¥æˆ–ç‚ºç©ºï¼`, 'error');
                    return false;
                }
                
                let questionsToReview = [];
                const questionCount = parseInt(document.getElementById('question-count').value);
                
                switch (this.state.selectedReviewMode) {
                    case 'wrong':
                        const incorrectQuestions = this.state.userData.incorrect || [];
                        questionsToReview = currentQuizData.filter(q => incorrectQuestions.includes(q.question));
                        if (questionsToReview.length === 0) {
                            this.showAlert('ç›®å‰æ²’æœ‰éŒ¯é¡Œè¨˜éŒ„ï¼Œè«‹å…ˆé€²è¡Œç·´ç¿’ï¼', 'info');
                            return false;
                        }
                        break;
                    case 'all':
                        questionsToReview = currentQuizData.slice(0, Math.min(questionCount, currentQuizData.length));
                        break;
                    case 'topic':
                    case 'random':
                        questionsToReview = [...currentQuizData].sort(() => Math.random() - 0.5).slice(0, Math.min(questionCount, currentQuizData.length));
                        break;
                    default:
                        this.showAlert('æœªçŸ¥çš„è¤‡ç¿’æ¨¡å¼ï¼', 'error');
                        return false;
                }
                
                this.state.questions = questionsToReview;
                this.state.questions.forEach((q, index) => q.number = index + 1);
                return true;
            },
            
            // é¸æ“‡é¡Œåº«
            selectDatabase(type) {
                this.elements.databaseCards.forEach(card => card.classList.remove('selected'));
                document.querySelector(`[data-type="${type}"]`).classList.add('selected');
                this.state.selectedDatabase = type;
                this.updateDatabaseUI(type);
                this.elements.startBtn.disabled = false;
                this.updateReviewButtonState();
                console.log(`âœ… å·²é¸æ“‡é¡Œåº«: ${type}`);
            },
            
            // æ›´æ–°é¡Œåº«UI
            updateDatabaseUI(type) {
                const databaseNames = { 'generative-ai': 'ç”Ÿæˆå¼AIèªè­‰', 'ipas': 'iPAS AIæ‡‰ç”¨è¦åŠƒå¸«' };
                this.elements.timerElement.innerHTML = `<i class="fas fa-clock me-2"></i>å·²é¸æ“‡ï¼š${databaseNames[type] || type}`;
                if (type === 'ipas') {
                    document.getElementById('question-count').value = '60';
                    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('[data-mode="practice"]').classList.add('active');
                    this.state.currentMode = 'practice';
                }
            },
            
            // æ›´æ–°è¤‡ç¿’æŒ‰éˆ•ç‹€æ…‹
            updateReviewButtonState() {
                const hasWrongQuestions = this.state.userData.incorrect && this.state.userData.incorrect.length > 0;
                const hasSelectedDatabase = this.state.selectedDatabase !== null;
                
                this.elements.reviewModesSection.style.display = hasSelectedDatabase ? 'block' : 'none';
                this.elements.reviewBtnMain.style.display = hasSelectedDatabase ? 'block' : 'none';
                
                const wrongModeItem = document.getElementById('review-wrong-mode');
                if (wrongModeItem) {
                    wrongModeItem.style.opacity = hasWrongQuestions ? '1' : '0.5';
                    wrongModeItem.style.pointerEvents = hasWrongQuestions ? 'auto' : 'none';
                    wrongModeItem.title = hasWrongQuestions ? 'è¤‡ç¿’ä¹‹å‰ç­”éŒ¯çš„é¡Œç›®' : 'å°šç„¡éŒ¯é¡Œè¨˜éŒ„';
                }
                
                this.elements.reviewBtnMain.disabled = !hasSelectedDatabase;
            },
            
            // é–‹å§‹æ¸¬é©—
            startQuiz() {
                if (!this.state.selectedDatabase) return this.showAlert('è«‹å…ˆé¸æ“‡é¡Œåº«ï¼', 'warning');
                
                this.showLoading('æº–å‚™æ¸¬é©—ä¸­...');
                this.state.isQuizActive = true;
                this.lockInterface();
                const questionCount = parseInt(document.getElementById('question-count').value);
                
                setTimeout(() => {
                    if (this.loadQuestions(questionCount)) {
                        this.state.currentQuestionIndex = 0;
                        this.state.userAnswers = {};
                        this.state.questionMapping = {};
                        this.state.score = 0;
                        this.state.wrongQuestions = [];
                        this.state.startTime = new Date();
                        
                        this.elements.settingsPanel.classList.add('d-none');
                        this.elements.quizContainer.classList.remove('d-none');
                        this.elements.quizStatus.style.display = 'block';
                        this.elements.quizStatus.classList.add('active');
                        
                        this.displayQuestion();
                        if (this.state.currentMode === 'exam') this.startTimer();
                        
                        this.hideLoading();
                        console.log('âœ… æ¸¬é©—å·²é–‹å§‹');
                    } else {
                        this.hideLoading();
                        this.state.isQuizActive = false;
                        this.unlockInterface();
                    }
                }, 500);
            },
            
            // é–å®š/è§£é–ä»‹é¢
            lockInterface() {
                this.elements.databaseSelector.classList.add('disabled');
                this.elements.settingsPanel.classList.add('disabled');
            },
            
            unlockInterface() {
                this.elements.databaseSelector.classList.remove('disabled');
                this.elements.settingsPanel.classList.remove('disabled');
            },
            
            // è¼‰å…¥é¡Œç›®
            loadQuestions(count) {
                const currentQuizData = quizData[this.state.selectedDatabase];
                if (!currentQuizData || currentQuizData.length === 0) {
                    this.showAlert(`${this.state.selectedDatabase === 'ipas' ? 'iPAS' : 'ç”Ÿæˆå¼AI'}é¡Œåº«å°šæœªè¼‰å…¥æˆ–ç‚ºç©ºï¼`, 'error');
                    return false;
                }
                const shuffledQuestions = [...currentQuizData].sort(() => Math.random() - 0.5);
                this.state.questions = shuffledQuestions.slice(0, Math.min(count, shuffledQuestions.length));
                this.state.questions.forEach((q, index) => q.number = index + 1);
                return true;
            },
            
            // é¡¯ç¤ºé¡Œç›®
            displayQuestion() {
                if (this.state.currentQuestionIndex >= this.state.questions.length) return this.finishQuiz();
                
                const question = this.state.questions[this.state.currentQuestionIndex];
                const qId = this.state.currentQuestionIndex;
                
                this.elements.questionNumber.textContent = `å•é¡Œ ${question.number}/${this.state.questions.length}`;
                this.elements.questionText.textContent = question.question;
                
                if (!this.state.questionMapping[qId]) {
                    const optionsWithIndex = question.options.map((opt, i) => ({ text: opt, originalIndex: i, isCorrect: i === question.correct_answer_index }));
                    const shuffledOptions = [...optionsWithIndex].sort(() => Math.random() - 0.5);
                    this.state.questionMapping[qId] = { shuffledOptions, correctLetter: String.fromCharCode(65 + shuffledOptions.findIndex(o => o.isCorrect)) };
                }
                
                const mapping = this.state.questionMapping[qId];
                this.elements.optionsContainer.innerHTML = mapping.shuffledOptions.map((opt, i) => {
                    const letter = String.fromCharCode(65 + i);
                    return `
                        <div class="form-check mb-2">
                            <input class="option-input" type="radio" name="quiz-option" id="option-${letter}" value="${letter}" data-original-index="${opt.originalIndex}">
                            <label class="option-label" for="option-${letter}">${letter}. ${opt.text}</label>
                        </div>`;
                }).join('');
                
                if (qId in this.state.userAnswers) {
                    const prevAns = this.state.userAnswers[qId];
                    const ansInput = document.getElementById(`option-${prevAns.answer}`);
                    if (ansInput) ansInput.checked = true;
                    document.querySelectorAll('input[name="quiz-option"]').forEach(input => input.disabled = true);
                    if (this.state.currentMode !== 'exam') this.showExplanation(question, prevAns.answer, prevAns.isCorrect);
                } else {
                    this.elements.explanationBox.classList.add('d-none');
                }
                
                this.elements.progressBar.style.width = `${((this.state.currentQuestionIndex + 1) / this.state.questions.length) * 100}%`;
                this.updateButtonStates();
                this.updateStats();
            },
            
            // æäº¤ç­”æ¡ˆ
            submitAnswer() {
                const selectedOption = document.querySelector('input[name="quiz-option"]:checked');
                if (!selectedOption) return this.showAlert('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼', 'warning');
                
                const question = this.state.questions[this.state.currentQuestionIndex];
                const qId = this.state.currentQuestionIndex;
                const userAnswerLetter = selectedOption.value;
                const originalIndex = parseInt(selectedOption.dataset.originalIndex);
                const isCorrect = originalIndex === question.correct_answer_index;
                
                this.state.userAnswers[qId] = { answer: userAnswerLetter, originalIndex, isCorrect, timestamp: new Date() };
                
                if (isCorrect) {
                    this.state.score++;
                    if (!this.state.userData.correct.includes(question.question)) this.state.userData.correct.push(question.question);
                    const idx = this.state.userData.incorrect.indexOf(question.question);
                    if (idx > -1) this.state.userData.incorrect.splice(idx, 1);
                } else {
                    this.state.wrongQuestions.push(question);
                    if (!this.state.userData.incorrect.includes(question.question)) this.state.userData.incorrect.push(question.question);
                }
                
                const historyEntry = {
                    timestamp: new Date().toISOString(), database: this.state.selectedDatabase, question: question.question,
                    options: question.options, user_answer: userAnswerLetter,
                    correct_answer_letter: this.state.questionMapping[qId].correctLetter, correct_answer_index: question.correct_answer_index,
                    is_correct: isCorrect, topic: question.topic, subtopic: question.subtopic, explanation: question.explanation
                };
                this.state.userData.history.push(historyEntry);
                
                if (this.state.currentMode !== 'exam') {
                    this.showExplanation(question, userAnswerLetter, isCorrect);
                    document.querySelectorAll('input[name="quiz-option"]').forEach(input => input.disabled = true);
                }
                
                this.updateStats();
                this.updateButtonStates();
                this.saveUserData(false);
            },
            
            // é¡¯ç¤ºè§£æ
            showExplanation(question, userAnswerLetter, isCorrect) {
                this.elements.explanationBox.classList.remove('d-none');
                const qId = this.state.currentQuestionIndex;
                const correctAnswerLetter = this.state.questionMapping[qId].correctLetter;
                const resultClass = isCorrect ? 'correct' : 'incorrect';
                const resultIcon = isCorrect ? 'âœ…' : 'âŒ';
                const resultText = isCorrect ? 'ç­”å°äº†ï¼' : `ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correctAnswerLetter}`;
                
                let explanationHTML = `<div class="${resultClass} mb-3">${resultIcon} ${resultText}</div><div class="fw-bold mb-2">è§£æ:</div>`;
                explanationHTML += `<div class="highlight">${question.explanation || 'ç„¡è§£æ'}</div>`;
                
                this.elements.explanationContent.innerHTML = explanationHTML;
                this.elements.topicBadge.textContent = question.topic || 'æœªåˆ†é¡';
                this.elements.subtopicBadge.textContent = question.subtopic || 'æœªåˆ†é¡';
            },
            
            // æŸ¥çœ‹ç•¶å‰è§£æ
            showCurrentExplanation() {
                if (this.state.currentQuestionIndex in this.state.userAnswers) {
                    const question = this.state.questions[this.state.currentQuestionIndex];
                    const userAnswerData = this.state.userAnswers[this.state.currentQuestionIndex];
                    this.showExplanation(question, userAnswerData.answer, userAnswerData.isCorrect);
                    this.showAlert('å·²é¡¯ç¤ºç•¶å‰é¡Œç›®è§£æ', 'info');
                } else {
                    this.showAlert('å»ºè­°å…ˆå›ç­”é¡Œç›®å†æŸ¥çœ‹è§£æï¼Œé€™æ¨£å­¸ç¿’æ•ˆæœæ›´å¥½ï¼', 'info');
                }
            },
            
            // ä¸‹ä¸€é¡Œ / ä¸Šä¸€é¡Œ
            nextQuestion() {
                if (this.state.currentQuestionIndex < this.state.questions.length - 1) {
                    this.state.currentQuestionIndex++;
                    this.displayQuestion();
                } else {
                    this.finishQuiz();
                }
            },
            
            prevQuestion() {
                if (this.state.currentQuestionIndex > 0 && this.state.currentMode !== 'exam') {
                    this.state.currentQuestionIndex--;
                    this.displayQuestion();
                }
            },
            
            // è¿”å›é¡Œåº«é¸æ“‡
            backToSelection() {
                if (this.state.isQuizActive) {
                    if (!confirm('ç¢ºå®šè¦æ”¾æ£„ç•¶å‰æ¸¬é©—ä¸¦è¿”å›å—ï¼Ÿé€²åº¦å°‡ä¸æœƒè¢«ä¿å­˜ã€‚')) return;
                }
                this.state.isQuizActive = false;
                this.unlockInterface();
                this.stopTimer();
                this.elements.quizContainer.classList.add('d-none');
                this.elements.settingsPanel.classList.remove('d-none');
                this.elements.quizStatus.style.display = 'none';
                this.elements.quizStatus.classList.remove('active');
                console.log('ğŸ”™ å·²è¿”å›é¡Œåº«é¸æ“‡');
            },
            
            // === ä¿®æ”¹å¾Œçš„å•å·æµç¨‹å‡½å¼ ===
            finishQuiz() {
                this.stopTimer();
                this.state.currentTestResults = this.calculateTestResults();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºé¦–æ¬¡æ¸¬é©—
                const isFirstTime = !this.state.surveyCompleted;
                
                if (isFirstTime) {
                    console.log('ğŸ†• é¦–æ¬¡æ¸¬é©—ï¼Œé¡¯ç¤ºå¼·åˆ¶å®Œæ•´å•å·');
                    this.showMandatorySurvey();
                } else {
                    console.log('ğŸ”„ éé¦–æ¬¡æ¸¬é©—ï¼Œé¡¯ç¤ºé¸æ“‡');
                    this.showResultChoice();
                }
            },

            // è¨ˆç®—æ¸¬é©—çµæœ
            calculateTestResults() {
                const total = this.state.questions.length;
                const score = this.state.score;
                const accuracy = total > 0 ? (score / total) : 0;
                const duration = this.calculateTimeTaken();
                
                // è¨ˆç®—éŒ¯èª¤ä¸»é¡Œ
                const wrongTopics = [...new Set(
                    this.state.wrongQuestions.map(q => q.topic || 'æœªåˆ†é¡')
                )];
                
                return {
                    score: score,
                    total: total,
                    accuracy: accuracy,
                    duration: duration,
                    wrongTopics: wrongTopics,
                    mode: this.state.currentMode,
                    database: this.state.selectedDatabase,
                    timestamp: new Date().toISOString()
                };
            },

            // é¡¯ç¤ºå¼·åˆ¶å•å· (é¦–æ¬¡) - è¼‰å…¥ full_survey.html
            async showMandatorySurvey() {
                try {
                    const modalHTML = `
                    <div class="modal fade" id="mandatorySurveyModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">ğŸ‰ æ¸¬é©—å®Œæˆï¼è«‹å¡«å¯«å›é¥‹å•å·</h5>
                                </div>
                                <div class="modal-body p-0">
                                    <div id="surveyContainer" style="height: calc(100vh - 120px); overflow-y: auto;">
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                            </div>
                                            <p class="mt-2">è¼‰å…¥å•å·ä¸­...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    // ç§»é™¤èˆŠçš„modal
                    const existingModal = document.getElementById('mandatorySurveyModal');
                    if (existingModal) existingModal.remove();
                    
                    // æ’å…¥æ–°modal
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    
                    // é¡¯ç¤ºmodal
                    const modal = new bootstrap.Modal(document.getElementById('mandatorySurveyModal'));
                    modal.show();
                    
                    // è¼‰å…¥å¤–éƒ¨å•å·HTML
                    await this.loadExternalSurvey('full_survey.html', 'surveyContainer');
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥å¼·åˆ¶å•å·å¤±æ•—:', error);
                    this.showAlert('å•å·è¼‰å…¥å¤±æ•—ï¼Œå°‡ç›´æ¥é¡¯ç¤ºçµæœ', 'error');
                    this.showResult();
                }
            },

            // é¡¯ç¤ºçµæœé¸æ“‡ (éé¦–æ¬¡) - ç›´æ¥é¡¯ç¤ºçµæœï¼Œé™„åŠ å›é¥‹å•å·é¸é …
            showResultChoice() {
                // ç›´æ¥é¡¯ç¤ºæ¸¬é©—çµæœ
                this.showResultWithSurveyOption();
                this.sendLineNotification(); // ç™¼é€LINEé€šçŸ¥
            },

            // é¡¯ç¤ºå¯é¸å•å· (éé¦–æ¬¡) - è¼‰å…¥ quick_survey.html
            async showOptionalSurvey() {
                try {
                    const modalHTML = `
                    <div class="modal fade" id="optionalSurveyModal" tabindex="-1" data-bs-backdrop="static">
                        <div class="modal-dialog modal-fullscreen">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title">ğŸ“ å•å·å›é¥‹ï¼ˆæ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ï¼‰</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body p-0">
                                    <div id="surveyContainer" style="height: calc(100vh - 120px); overflow-y: auto;">
                                        <div class="text-center p-4">
                                            <div class="spinner-border text-warning" role="status">
                                                <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                                            </div>
                                            <p class="mt-2">è¼‰å…¥å•å·ä¸­...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    
                    // ç§»é™¤èˆŠmodal
                    const existingModal = document.getElementById('optionalSurveyModal');
                    if (existingModal) existingModal.remove();
                    
                    // æ’å…¥æ–°modal
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    
                    // é¡¯ç¤ºmodal
                    const modal = new bootstrap.Modal(document.getElementById('optionalSurveyModal'));
                    modal.show();
                    
                    // è¼‰å…¥å¤–éƒ¨å•å·HTML
                    await this.loadExternalSurvey('quick_survey.html', 'surveyContainer');
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥å¯é¸å•å·å¤±æ•—:', error);
                    this.showAlert('å•å·è¼‰å…¥å¤±æ•—ï¼Œå°‡ç›´æ¥é¡¯ç¤ºçµæœ', 'error');
                    this.showResult();
                }
            },

            // è¼‰å…¥å¤–éƒ¨å•å·HTMLæ–‡ä»¶
            async loadExternalSurvey(fileName, containerId) {
                try {
                    console.log(`ğŸ“„ é–‹å§‹è¼‰å…¥å¤–éƒ¨å•å·: ${fileName}`);
                    
                    const response = await fetch(`./${fileName}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const htmlContent = await response.text();
                    const container = document.getElementById(containerId);
                    
                    if (!container) {
                        throw new Error(`æ‰¾ä¸åˆ°å®¹å™¨: ${containerId}`);
                    }
                    
                    // å°‡HTMLå…§å®¹æ’å…¥å®¹å™¨
                    container.innerHTML = htmlContent;
                    
                    // åˆå§‹åŒ–å•å·åŠŸèƒ½
                    this.initializeExternalSurvey();
                    
                    console.log(`âœ… å¤–éƒ¨å•å·è¼‰å…¥æˆåŠŸ: ${fileName}`);
                    
                } catch (error) {
                    console.error(`âŒ è¼‰å…¥å¤–éƒ¨å•å·å¤±æ•— (${fileName}):`, error);
                    
                    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div class="alert alert-danger m-4">
                                <h5 class="alert-heading">âŒ å•å·è¼‰å…¥å¤±æ•—</h5>
                                <p>ç„¡æ³•è¼‰å…¥å•å·æ–‡ä»¶ ${fileName}ï¼Œè«‹æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚</p>
                                <hr>
                                <button class="btn btn-primary" onclick="iPASQuizApp.showResult()">
                                    <i class="fas fa-eye me-2"></i>ç›´æ¥æŸ¥çœ‹æ¸¬é©—çµæœ
                                </button>
                            </div>
                        `;
                    }
                    throw error;
                }
            },

            // åˆå§‹åŒ–å¤–éƒ¨å•å·åŠŸèƒ½
            initializeExternalSurvey() {
                // å°‹æ‰¾å•å·è¡¨å–®
                const form = document.querySelector('#embeddedSurveyForm, #quickSurveyForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSurveySubmit(form);
                    });
                }
                
                // è¨­ç½®å•å·äº’å‹•é‚è¼¯
                this.setupSurveyInteractions();
                
                console.log('ğŸ“‹ å¤–éƒ¨å•å·åŠŸèƒ½å·²åˆå§‹åŒ–');
            },

            // è¨­ç½®å•å·äº’å‹•é‚è¼¯
            setupSurveyInteractions() {
                // è·³éå¿«é€Ÿå•å·çš„æŒ‰éˆ•
                const skipBtn = document.getElementById('skip-quick-survey');
                if (skipBtn) {
                    skipBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.closeSurveyModal();
                        this.showResult();
                    });
                }
                
                // è¤‡é¸æ¡†é™åˆ¶é‚è¼¯
                const favoriteFeatures = document.querySelectorAll('input[name="favorite_features"]');
                favoriteFeatures.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const checked = document.querySelectorAll('input[name="favorite_features"]:checked');
                        if (checked.length >= 3) {
                            favoriteFeatures.forEach(cb => {
                                if (!cb.checked) cb.disabled = true;
                            });
                        } else {
                            favoriteFeatures.forEach(cb => cb.disabled = false);
                        }
                    });
                });

                const premiumFeatures = document.querySelectorAll('input[name="premium_features"]');
                premiumFeatures.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const checked = document.querySelectorAll('input[name="premium_features"]:checked');
                        if (checked.length >= 3) {
                            premiumFeatures.forEach(cb => {
                                if (!cb.checked) cb.disabled = true;
                            });
                        } else {
                            premiumFeatures.forEach(cb => cb.disabled = false);
                        }
                    });
                });

                // å…¶ä»–é¸é …é¡¯ç¤º/éš±è—é‚è¼¯
                this.setupOtherInputs();
            },

            // è¨­ç½®å…¶ä»–é¸é …è¼¸å…¥æ¡†
            setupOtherInputs() {
                // æº–å‚™ç›®æ¨™çš„å…¶ä»–é¸é …
                const goalRadios = document.querySelectorAll('input[name="goal"]');
                goalRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        const otherInput = document.getElementById('goalOtherInput');
                        if (otherInput) {
                            if (radio.value === 'other' && radio.checked) {
                                otherInput.style.display = 'block';
                                otherInput.querySelector('input').required = true;
                            } else if (radio.checked) {
                                otherInput.style.display = 'none';
                                otherInput.querySelector('input').required = false;
                                otherInput.querySelector('input').value = '';
                            }
                        }
                    });
                });

                // æ™‚é–“è¦åŠƒçš„å…¶ä»–é¸é …
                const timelineRadios = document.querySelectorAll('input[name="timeline"]');
                timelineRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        const otherInput = document.getElementById('timelineOtherInput');
                        if (otherInput) {
                            if (radio.value === 'other' && radio.checked) {
                                otherInput.style.display = 'block';
                                otherInput.querySelector('input').required = true;
                            } else if (radio.checked) {
                                otherInput.style.display = 'none';
                                otherInput.querySelector('input').required = false;
                                otherInput.querySelector('input').value = '';
                            }
                        }
                    });
                });

                // ä»˜è²»æƒ…æ³çš„å…¶ä»–é¸é …
                const paymentRadios = document.querySelectorAll('input[name="payment_scenario"]');
                paymentRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        const otherInput = document.getElementById('paymentOtherInput');
                        if (otherInput) {
                            if (radio.value === 'other' && radio.checked) {
                                otherInput.style.display = 'block';
                                otherInput.querySelector('input').required = true;
                            } else if (radio.checked) {
                                otherInput.style.display = 'none';
                                otherInput.querySelector('input').required = false;
                                otherInput.querySelector('input').value = '';
                            }
                        }
                    });
                });
            },

            // è™•ç†å•å·æäº¤
            async handleSurveySubmit(form) {
                try {
                    // æ”¶é›†å•å·æ•¸æ“š
                    const surveyData = this.collectSurveyData(form);
                    
                    // åˆä½µæ¸¬é©—æ•¸æ“š
                    const completeData = {
                        ...surveyData,
                        test_score: this.state.currentTestResults.score,
                        test_total: this.state.currentTestResults.total,
                        test_accuracy: this.state.currentTestResults.accuracy,
                        test_duration: this.state.currentTestResults.duration,
                        wrong_topics: this.state.currentTestResults.wrongTopics,
                        test_mode: this.state.currentTestResults.mode,
                        database_type: this.state.currentTestResults.database
                    };
                    
                    console.log('ğŸ“¤ æäº¤å•å·æ•¸æ“š:', completeData);
                    
                    // é¡¯ç¤ºæäº¤ä¸­ç‹€æ…‹
                    this.showSubmittingState();
                    
                    // æäº¤åˆ°n8n
                    const response = await fetch(this.state.webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(completeData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… å•å·æäº¤æˆåŠŸ:', result);
                        
                        // æ¨™è¨˜å•å·å·²å®Œæˆ
                        localStorage.setItem('iPAS_survey_completed', 'true');
                        this.state.surveyCompleted = true;
                        
                        // é—œé–‰å•å·modal
                        this.closeSurveyModal();
                        
                        // é¡¯ç¤ºæ¸¬é©—çµæœ
                        this.showEnhancedResult(completeData);
                        
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ å•å·æäº¤å¤±æ•—:', error);
                    this.showAlert('å•å·æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦', 'error');
                }
            },

            // æ”¶é›†å•å·æ•¸æ“š
            collectSurveyData(form) {
                const formData = new FormData(form);
                
                // åˆ¤æ–·æ˜¯å®Œæ•´å•å·é‚„æ˜¯å¿«é€Ÿå•å·
                const isFullSurvey = form.id === 'embeddedSurveyForm';
                
                if (isFullSurvey) {
                    return {
                        timestamp: new Date().toISOString(),
                        survey_type: 'full',
                        identity: formData.get('identity'),
                        goal: formData.get('goal'),
                        goal_other: formData.get('goal_other') || null,
                        timeline: formData.get('timeline'),
                        timeline_other: formData.get('timeline_other') || null,
                        satisfaction: parseInt(formData.get('satisfaction')),
                        favorite_features: formData.getAll('favorite_features'),
                        payment_scenario: formData.get('payment_scenario'),
                        payment_scenario_other: formData.get('payment_scenario_other') || null,
                        price_range: formData.get('price_range'),
                        premium_features: formData.getAll('premium_features'),
                        nps: parseInt(formData.get('nps')),
                        recommendation_reason: formData.get('recommendation_reason'),
                        line_id: formData.get('line_id'),
                        participation: formData.getAll('participation')
                    };
                } else {
                    return {
                        timestamp: new Date().toISOString(),
                        survey_type: 'quick',
                        feeling: formData.get('feeling'),
                        difficulty: formData.get('difficulty'),
                        ai_tutor_interest: formData.get('ai_tutor_interest'),
                        recommendation_score: formData.get('recommendation_score'),
                        suggestion: formData.get('suggestion')
                    };
                }
            },

            // é¡¯ç¤ºæäº¤ä¸­ç‹€æ…‹
            showSubmittingState() {
                const submitBtn = document.querySelector('form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä¸­...';
                }
            },

            // é—œé–‰å•å·modal
            closeSurveyModal() {
                // é—œé–‰å¼·åˆ¶å•å·modal
                const mandatoryModal = document.getElementById('mandatorySurveyModal');
                if (mandatoryModal) {
                    const modal = bootstrap.Modal.getInstance(mandatoryModal);
                    if (modal) modal.hide();
                }
                
                // é—œé–‰å¯é¸å•å·modal
                const optionalModal = document.getElementById('optionalSurveyModal');
                if (optionalModal) {
                    const modal = bootstrap.Modal.getInstance(optionalModal);
                    if (modal) modal.hide();
                }
            },

            // ç™¼é€LINEé€šçŸ¥
            sendLineNotification() {
                // LINEé€šçŸ¥é‚è¼¯å·²ç¶“åœ¨n8nä¸­è™•ç†
                console.log('ğŸ“± LINEé€šçŸ¥å°‡é€šén8nç™¼é€');
            },

            // é¡¯ç¤ºå¢å¼·çµæœ
            showEnhancedResult(surveyData) {
                const results = this.state.currentTestResults;
                const accuracy = Math.round(results.accuracy * 100);
                
                let resultHTML = `
                    <div class="text-center mb-4">
                        <h3>ğŸ‰ æ¸¬é©—åˆ†æå ±å‘Š</h3>
                        <div class="alert alert-success">
                            <i class="fas fa-gift me-2"></i>æ„Ÿè¬å®Œæˆå•å·ï¼æ‚¨å·²ç²å¾—æ‰€æœ‰çå‹µå…§å®¹
                        </div>
                    </div>
                    
                    <div class="row text-center mb-4">
                        <div class="col-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h4 class="text-primary">${results.score}</h4>
                                    <small>å¾—åˆ†</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h4 class="text-info">${results.total}</h4>
                                    <small>ç¸½é¡Œæ•¸</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h4 class="text-warning">${accuracy}%</h4>
                                    <small>æ­£ç¢ºç‡</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h4 class="text-secondary">${results.duration}</h4>
                                    <small>ç”¨æ™‚(åˆ†)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">ğŸ æ‚¨å·²ç²å¾—çš„çå‹µï¼š</h5>
                        <ul class="mb-0">
                            <li>ğŸ“Š ä¸Šæ–¹è©³ç´°æ¸¬é©—åˆ†æ</li>
                            <li>ğŸ¤– AIå€‹äººåŒ–å­¸ç¿’å»ºè­°ï¼ˆå°‡ç™¼é€è‡³ä¿¡ç®±ï¼‰</li>
                            <li>ğŸ“± LINE BotéŒ¯é¡Œæé†’å·²å•Ÿå‹•</li>
                            <li>ğŸ’ 7å¤©é€²éšåŠŸèƒ½å·²é–‹é€š</li>
                        </ul>
                    </div>`;
                
                // å¦‚æœæœ‰éŒ¯é¡Œï¼Œé¡¯ç¤ºéŒ¯é¡Œåˆ†æ
                if (this.state.wrongQuestions.length > 0) {
                    resultHTML += this._generateWrongQuestionsHTML();
                }
                
                document.getElementById('result-content').innerHTML = resultHTML;
                this.modals.result.show();
            },

            calculateTimeTaken() {
                if (this.state.startTime) return Math.round((new Date() - this.state.startTime) / 1000 / 60);
                return 0;
            },

            // é¡¯ç¤ºå¸¶æœ‰å•å·é¸é …çš„çµæœ (éé¦–æ¬¡æ¸¬é©—)
            showResultWithSurveyOption() {
                const total = this.state.questions.length;
                const score = this.state.score;
                const percentage = total > 0 ? (score / total * 100).toFixed(1) : 0;
                const duration = this.calculateTimeTaken();
                
                let resultHTML = `
                    <div class="text-center mb-4">
                        <h3>ğŸ“Š ${this.state.currentMode === 'review' ? 'è¤‡ç¿’' : 'æ¸¬é©—'}çµæœ</h3>
                        <div class="progress my-3" style="height: 25px;"><div class="progress-bar ${percentage >= 70 ? 'bg-success' : 'bg-warning'}" style="width: ${percentage}%">${percentage}%</div></div>
                    </div>
                    <div class="row text-center mb-4">
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-primary">${score}</h4><small>å¾—åˆ†</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-info">${total}</h4><small>ç¸½é¡Œæ•¸</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-warning">${percentage}%</h4><small>æ­£ç¢ºç‡</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-secondary">${duration}åˆ†</h4><small>ç”¨æ™‚</small></div></div></div>
                    </div>
                    <div class="alert ${percentage >= 70 ? 'alert-success' : 'alert-warning'} mb-4">
                        <h5 class="alert-heading">${percentage >= 70 ? 'ğŸ‰ æ­å–œé€šéï¼' : 'ğŸ’ª ç¹¼çºŒåŠªåŠ›ï¼'}</h5>
                        <p class="mb-0">${percentage >= 70 ? 'é”åˆ°iPASåˆæ ¼æ¨™æº–(70%)ï¼Œè€ƒè©¦æº–å‚™è‰¯å¥½ï¼' : 'è·é›¢åˆæ ¼æ¨™æº–é‚„éœ€è¦åŠ å¼·ï¼Œå»ºè­°å¤šåŠ ç·´ç¿’éŒ¯é¡Œã€‚'}</p>
                    </div>
                    
                    <!-- æ–°å¢ï¼šå›é¥‹å•å·é¸é … -->
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="alert-heading mb-1">ğŸ’­ å¹«åŠ©æˆ‘å€‘æ”¹å–„ç³»çµ±</h6>
                                <small>å¡«å¯«ç°¡çŸ­å›é¥‹å•å·ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨æä¾›æ›´å¥½çš„å­¸ç¿’é«”é©—</small>
                            </div>
                            <button class="btn btn-outline-primary btn-sm" id="openSurveyBtn">
                                <i class="fas fa-edit me-1"></i>å¡«å¯«å›é¥‹
                            </button>
                        </div>
                    </div>
                `;
                
                // å¦‚æœæœ‰éŒ¯é¡Œï¼Œé¡¯ç¤ºéŒ¯é¡Œåˆ†æ
                if (this.state.wrongQuestions.length > 0) {
                    resultHTML += this._generateWrongQuestionsHTML();
                }
                
                document.getElementById('result-content').innerHTML = resultHTML;
                
                // ç¶å®šå›é¥‹å•å·æŒ‰éˆ•äº‹ä»¶
                const surveyBtn = document.getElementById('openSurveyBtn');
                if (surveyBtn) {
                    surveyBtn.addEventListener('click', () => {
                        this.modals.result.hide();
                        this.showOptionalSurvey();
                    });
                }
                
                this.modals.result.show();
            },
            
            // é¡¯ç¤ºçµæœ (éå•å·æµç¨‹)
            showResult() {
                const total = this.state.questions.length;
                const score = this.state.score;
                const percentage = total > 0 ? (score / total * 100).toFixed(1) : 0;
                const duration = this.calculateTimeTaken();
                
                let resultHTML = `
                    <div class="text-center mb-4">
                        <h3>ğŸ“Š ${this.state.currentMode === 'review' ? 'è¤‡ç¿’' : 'æ¸¬é©—'}çµæœ</h3>
                        <div class="progress my-3" style="height: 25px;"><div class="progress-bar ${percentage >= 70 ? 'bg-success' : 'bg-warning'}" style="width: ${percentage}%">${percentage}%</div></div>
                    </div>
                    <div class="row text-center mb-4">
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-primary">${score}</h4><small>å¾—åˆ†</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-info">${total}</h4><small>ç¸½é¡Œæ•¸</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-warning">${percentage}%</h4><small>æ­£ç¢ºç‡</small></div></div></div>
                        <div class="col-3"><div class="card border-0 bg-light"><div class="card-body"><h4 class="text-secondary">${duration}åˆ†</h4><small>ç”¨æ™‚</small></div></div></div>
                    </div>
                    <div class="alert ${percentage >= 70 ? 'alert-success' : 'alert-warning'} mb-4">
                        <h5 class="alert-heading">${percentage >= 70 ? 'ğŸ‰ æ­å–œé€šéï¼' : 'ğŸ’ª ç¹¼çºŒåŠªåŠ›ï¼'}</h5>
                        <p class="mb-0">${percentage >= 70 ? 'é”åˆ°iPASåˆæ ¼æ¨™æº–(70%)ï¼Œè€ƒè©¦æº–å‚™è‰¯å¥½ï¼' : 'è·é›¢åˆæ ¼æ¨™æº–é‚„éœ€è¦åŠ å¼·ï¼Œå»ºè­°å¤šåŠ ç·´ç¿’éŒ¯é¡Œã€‚'}</p>
                    </div>
                `;
                
                if (this.state.wrongQuestions.length > 0) {
                    resultHTML += this._generateWrongQuestionsHTML();
                }
                
                document.getElementById('result-content').innerHTML = resultHTML;
                this.modals.result.show();
            },

            // æ–°å¢: ç”¢ç”ŸéŒ¯é¡Œåˆ†æHTMLçš„è¼”åŠ©å‡½å¼
            _generateWrongQuestionsHTML() {
                let wrongQuestionsHTML = `
                    <div class="card mt-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">âŒ éŒ¯é¡Œåˆ†æ (${this.state.wrongQuestions.length}é¡Œ)</h5>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                `;
                const topicWrongs = {};
                this.state.wrongQuestions.forEach(q => {
                    const topic = q.topic || 'æœªåˆ†é¡';
                    if (!topicWrongs[topic]) topicWrongs[topic] = [];
                    topicWrongs[topic].push(q);
                });

                for (const [topic, questions] of Object.entries(topicWrongs)) {
                    wrongQuestionsHTML += `<div class="mb-4"><h6 class="border-bottom pb-2">ã€${topic}ã€‘: ${questions.length}é¡Œ</h6>`;
                    questions.forEach((q, index) => {
                        const qOriginalIndex = this.state.questions.indexOf(q);
                        const userAnswerData = this.state.userAnswers[qOriginalIndex];
                        const qMapping = this.state.questionMapping[qOriginalIndex];
                        const qId = `wrong-q-detail-${topic.replace(/\s+/g, '-')}-${index}`;
                        
                        let userAnswerText = 'æœªä½œç­”', correctAnswerLetter = q.correct_answer_letter, correctAnswerText = q.options[q.correct_answer_index];

                        if (userAnswerData && qMapping) {
                            const userSelectedOpt = qMapping.shuffledOptions.find(opt => opt.originalIndex === userAnswerData.originalIndex);
                            if (userSelectedOpt) userAnswerText = userSelectedOpt.text;
                            correctAnswerLetter = qMapping.correctLetter;
                        } else if (userAnswerData) {
                            userAnswerText = q.options[userAnswerData.originalIndex] || 'æœªçŸ¥';
                        }
                        
                        wrongQuestionsHTML += `
                            <div class="mb-3">
                                <a class="fw-bold text-decoration-none text-dark" data-bs-toggle="collapse" href="#${qId}">${index+1}. ${q.question}</a>
                                <div class="ps-3 mt-1">
                                    <div class="text-danger">æ‚¨çš„ç­”æ¡ˆ: ${userAnswerData ? userAnswerData.answer : 'æœªä½œç­”'} (${userAnswerText})</div>
                                    <div class="text-success">æ­£ç¢ºç­”æ¡ˆ: ${correctAnswerLetter} (${correctAnswerText})</div>
                                    <div class="collapse mt-2" id="${qId}">
                                        <div class="card card-body bg-light">
                                            <h6 class="text-primary mb-2">é¡Œç›®è§£æ:</h6>
                                            ${q.explanation || 'ç„¡è§£æ'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    wrongQuestionsHTML += `</div>`;
                }
                wrongQuestionsHTML += `</div></div>`;
                return wrongQuestionsHTML;
            },
            
            // è¤‡ç¿’éŒ¯é¡Œ
            reviewWrongQuestions() {
                if (this.state.wrongQuestions.length === 0) return this.showAlert('æ²’æœ‰éŒ¯é¡Œéœ€è¦è¤‡ç¿’', 'info');
                
                this.modals.result.hide();
                this.state.currentMode = 'review';
                this.state.selectedReviewMode = 'wrong';
                
                this.state.questions = [...this.state.wrongQuestions];
                this.state.currentQuestionIndex = 0;
                this.state.score = 0;
                this.state.userAnswers = {};
                this.state.questionMapping = {};
                this.state.wrongQuestions = [];
                
                this.state.questions.forEach((q, index) => q.number = index + 1);
                
                this.displayQuestion();
                this.updateButtonStates();
                this.showAlert('é–‹å§‹è¤‡ç¿’éŒ¯é¡Œ', 'success');
            },
            
            // é‡æ–°æ¸¬é©—
            restartQuiz() {
                this.modals.result.hide();
                this.state.isQuizActive = false;
                this.stopTimer();
                this.unlockInterface();
                this.elements.quizContainer.classList.add('d-none');
                this.elements.settingsPanel.classList.remove('d-none');
                this.elements.quizStatus.style.display = 'none';
                this.elements.quizStatus.classList.remove('active');
                if (this.state.selectedDatabase) this.elements.startBtn.disabled = false;
                this.showAlert('å¯ä»¥é‡æ–°é¸æ“‡é¡Œç›®æ•¸é‡å’Œæ¸¬é©—è¨­å®šäº†ï¼', 'success');
            },
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateButtonStates() {
                const hasAnswered = this.state.currentQuestionIndex in this.state.userAnswers;
                const isFirst = this.state.currentQuestionIndex === 0;
                const isLast = this.state.currentQuestionIndex === this.state.questions.length - 1;
                
                this.elements.prevBtn.disabled = isFirst || this.state.currentMode === 'exam';
                this.elements.submitBtn.disabled = hasAnswered;
                this.elements.nextBtn.disabled = !hasAnswered || isLast;
                this.elements.finishBtn.disabled = !hasAnswered && !isLast;
                this.elements.explanationBtn.disabled = !hasAnswered;
            },
            
            // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
            updateStats() {
                const answered = Object.keys(this.state.userAnswers).length;
                const percentage = answered > 0 ? (this.state.score / answered * 100).toFixed(1) : 0;
                this.elements.statsDisplay.textContent = `å¾—åˆ†: ${this.state.score}/${answered} (${percentage}%)`;
            },
            
            // é¡¯ç¤ºçµ±è¨ˆè³‡æ–™
            showStatistics() {
                this.showAlert('çµ±è¨ˆåŠŸèƒ½è¼‰å…¥å®Œæˆ', 'info');
                this.modals.stats.show();
            },
            
            // åŒ¯å‡ºéŒ¯é¡Œ
            exportWrongQuestions() {
                this.showAlert('éŒ¯é¡Œå·²åŒ¯å‡º', 'success');
            },
            
            // é‡ç½®é€²åº¦
            resetProgress() {
                if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’é€²åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
                    this.state.userData = { correct: [], incorrect: [], history: [], databaseStats: {} };
                    this.saveUserData();
                    this.updateReviewButtonState();
                    this.modals.stats.hide();
                    this.showAlert('å­¸ç¿’é€²åº¦å·²é‡ç½®', 'success');
                }
            },
            
            // è¨ˆæ™‚å™¨
            startTimer() {
                this.state.isTimerRunning = true;
                this.state.startTime = new Date();
                this.updateTimer();
            },
            
            stopTimer() {
                this.state.isTimerRunning = false;
                if (this.state.timerId) clearTimeout(this.state.timerId);
            },
            
            updateTimer() {
                if (!this.state.isTimerRunning) return;
                const elapsed = Math.floor((new Date() - this.state.startTime) / 1000);
                const remaining = (this.state.examDuration * 60) - elapsed;
                
                if (remaining <= 0) {
                    this.updateTimerDisplay("00:00");
                    this.elements.timerElement.classList.add('warning');
                    this.stopTimer();
                    this.showAlert('æ™‚é–“åˆ°ï¼è€ƒè©¦çµæŸã€‚', 'warning');
                    this.finishQuiz();
                    return;
                }
                
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                this.updateTimerDisplay(`${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`);
                this.elements.timerElement.classList.toggle('warning', mins < 5);
                this.state.timerId = setTimeout(() => this.updateTimer(), 1000);
            },
            
            updateTimerDisplay(timeString) {
                this.elements.timerElement.innerHTML = `<i class="fas fa-clock me-2"></i>å‰©é¤˜æ™‚é–“: ${timeString}`;
            },
            
            // æç¤ºè¨Šæ¯
            showAlert(message, type = 'info') {
                const alertTypes = { success: 'alert-success', error: 'alert-danger', warning: 'alert-warning', info: 'alert-info' };
                const iconMap = { success: 'fa-check-circle', error: 'fa-exclamation-triangle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertTypes[type]} alert-dismissible fade show position-fixed`;
                alertDiv.style.cssText = `top: 100px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);`;
                alertDiv.innerHTML = `<i class="fas ${iconMap[type]} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                document.body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
            },
            
            // åŠ è¼‰å‹•ç•«
            showLoading(text = 'è™•ç†ä¸­...') {
                this.elements.loadingText.textContent = text;
                this.elements.loadingOverlay.classList.remove('d-none');
            },
            
            hideLoading() {
                this.elements.loadingOverlay.classList.add('d-none');
            }
        };
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            iPASQuizApp.init();
        });
    </script>
</body>
</html>
