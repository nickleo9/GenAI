<!DOCTYPE html>
<html lang="zh-TW">
<head>
<link rel="icon" href="data:,">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«å°ˆæ¥­ç·´ç¿’ç³»çµ±</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            padding: 10px;
            padding-bottom: 0;
            min-height: 100vh;
            margin-bottom: 120px;
            overflow-x: hidden;
        }
        
        .main-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 10px auto;
            margin-bottom: 130px;
            max-width: 95%;
            width: 100%;
            backdrop-filter: blur(10px);
            min-height: calc(100vh - 250px);
            padding-bottom: 40px;
        }
        
        .quiz-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1.5" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .quiz-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }
        
        .quiz-status {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 3;
        }
        
        .quiz-status.active {
            background: #28a745;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .database-selector {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            color: white;
            transition: all 0.3s ease;
        }
        
        .database-selector.disabled {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(70%);
            position: relative;
        }
        
        .database-selector.disabled::after {
            content: 'ğŸ”’ æ¸¬é©—é€²è¡Œä¸­ï¼Œç„¡æ³•åˆ‡æ›é¡Œåº«';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 10;
        }
        
        .database-card {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .database-card:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-3px);
        }
        
        .database-card.selected {
            background: rgba(255, 255, 255, 0.4);
            border-color: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .quiz-container {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin: 20px;
            margin-bottom: 40px;
        }
        
        .option-label {
            display: block;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            position: relative;
            overflow: hidden;
        }
        
        .option-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .option-label:hover {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-color: #2196f3;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }
        
        .option-label:hover::before {
            left: 100%;
        }
        
        .option-input:checked + .option-label {
            background: linear-gradient(145deg, #c8e6c9, #a5d6a7);
            border-color: #4caf50;
            color: #2e7d32;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        
        .option-input:checked + .option-label::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #4caf50;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            animation: checkmark 0.3s ease-in-out;
        }
        
        @keyframes checkmark {
            0% { transform: translateY(-50%) scale(0); }
            50% { transform: translateY(-50%) scale(1.2); }
            100% { transform: translateY(-50%) scale(1); }
        }
        
        .option-input {
            display: none;
        }
        
        .explanation-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 5px solid #007bff;
            padding: 25px;
            margin-top: 20px;
            border-radius: 12px;
            min-height: 150px;
            max-height: 500px;
            overflow-y: auto;
            word-wrap: break-word;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .explanation-box::-webkit-scrollbar { width: 8px; }
        .explanation-box::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 5px; }
        .explanation-box::-webkit-scrollbar-thumb { background: #007bff; border-radius: 5px; }
        .explanation-box::-webkit-scrollbar-thumb:hover { background: #0056b3; }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(248, 249, 250, 0.98));
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1040;
            padding: 20px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: none;
            font-size: 0.85rem;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .progress { height: 12px; margin-bottom: 20px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); }
        .progress-bar { background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); transition: width 0.5s ease; }
        .badge-custom { background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-size: 0.9rem; padding: 8px 15px; border-radius: 20px; margin: 5px; }
        .timer { font-size: 1.2rem; font-weight: bold; color: #FF5722; background: rgba(255, 255, 255, 0.9); padding: 10px 15px; border-radius: 25px; }
        .timer.warning { color: #dc3545; animation: blink 1s infinite; background: rgba(255, 0, 0, 0.1); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .correct { color: #198754; font-weight: bold; font-size: 1.1rem; }
        .incorrect { color: #dc3545; font-weight: bold; font-size: 1.1rem; }
        .highlight { background: linear-gradient(45deg, #fff3cd, #ffeaa7); padding: 15px; border-radius: 8px; margin: 10px 0; font-size: 1rem; line-height: 1.6; border-left: 4px solid #ffc107; }
        .nav-brand { background: linear-gradient(45deg, #667eea, #764ba2); color: white !important; font-weight: bold; border-radius: 10px; padding: 8px 16px !important; }
        .settings-panel { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 25px; margin: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .settings-panel.disabled { opacity: 0.6; pointer-events: none; }
        .mode-btn { background: linear-gradient(145deg, #ffffff, #f8f9fa); border: 2px solid #e1e8ed; border-radius: 12px; padding: 12px 16px; cursor: pointer; transition: all 0.3s ease; margin: 5px; font-weight: 600; }
        .mode-btn:hover { border-color: #667eea; transform: translateY(-1px); }
        .mode-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); border-color: #667eea; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .back-to-selection { background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; border-radius: 10px; padding: 8px 16px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; }
        .back-to-selection:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; }
        .loader { border: 5px solid rgba(255, 255, 255, 0.3); border-top: 5px solid #fff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 1.2rem; font-weight: bold; }
        .review-modes { background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border: 2px solid #28a745; border-radius: 12px; padding: 15px; margin: 10px 0; }
        .review-mode-item { background: rgba(255, 255, 255, 0.8); border: 1px solid #28a745; border-radius: 8px; padding: 10px 15px; margin: 5px 0; cursor: pointer; }
        .survey-container { background-color: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); margin: 0 auto; max-width: 900px; backdrop-filter: blur(10px); overflow: hidden; }
        .survey-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; }
        .survey-content { padding: 40px; }
        .question-card { background: #fff; border: 2px solid #e9ecef; border-radius: 15px; padding: 25px; margin-bottom: 25px; }
        .question-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: #333; }
        .survey-form-check { margin-bottom: 12px; padding: 12px 15px; background: #f8f9fa; border-radius: 8px; }
        .survey-form-check-input:checked ~ .survey-form-check-label { color: #667eea; font-weight: 600; }
        .submit-section { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; margin-top: 40px; border-radius: 15px; }
        .btn-submit { background: linear-gradient(45deg, #28a745, #20c997); border: none; border-radius: 25px; padding: 15px 40px; font-size: 1.2rem; font-weight: 600; color: white; }
        .btn-submit:disabled { background: #6c757d; cursor: not-allowed; }
        .required-indicator { color: #dc3545; font-weight: bold; }
        @media (max-width: 768px) { body { margin-bottom: 130px; } .main-container { margin: 5px auto; margin-bottom: 140px; } .survey-content { padding: 20px; } }
    </style>

    <script>
        let quizData = { 'generative-ai': [], 'ipas': [] };
        async function loadQuizDatabases() {
            try {
                const fetchWithCatch = url => fetch(url).catch(() => ({ ok: false, json: () => Promise.resolve([]) }));
                const [res1, res2] = await Promise.all([
                    fetchWithCatch('./æ¨¡æ“¬è€ƒé¡Œ.json'),
                    fetchWithCatch('./æ‡‰ç”¨æ¨¡æ“¬è€ƒé¡Œ.json')
                ]);
                if (res1.ok) quizData['generative-ai'] = await res1.json();
                if (res2.ok) quizData['ipas'] = await res2.json();
                if (quizData['ipas'].length === 0 && quizData['generative-ai'].length === 0) {
                    quizData['ipas'] = [{ question: "ç¤ºä¾‹å•é¡Œï¼šæœ¬åœ°é¡Œåº«æª”æ¡ˆæœªæ‰¾åˆ°", options: ["é¸é …A", "é¸é …B", "é¸é …C", "é¸é …D"], correct_answer_index: 0, explanation: "è«‹ç¢ºä¿é¡Œåº« JSON æª”æ¡ˆèˆ‡ HTML åœ¨åŒä¸€å€‹ç›®éŒ„ä¸‹ã€‚" }];
                    setTimeout(() => alert('æœ¬åœ°é¡Œåº«æª”æ¡ˆæœªæ‰¾åˆ°ï¼Œå·²è¼‰å…¥ç¤ºä¾‹é¡Œç›®ï¼'), 1000);
                }
            } catch (error) { console.error('é¡Œåº«è¼‰å…¥éŒ¯èª¤:', error); }
        }
        document.addEventListener('DOMContentLoaded', loadQuizDatabases);
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand nav-brand" href="#"><i class="fas fa-graduation-cap me-2"></i>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" id="save-btn"><i class="fas fa-save me-1"></i>å„²å­˜é€²åº¦</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="export-btn"><i class="fas fa-download me-1"></i>åŒ¯å‡ºéŒ¯é¡Œ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="stats-btn"><i class="fas fa-chart-bar me-1"></i>å­¸ç¿’çµ±è¨ˆ</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="help-btn"><i class="fas fa-question-circle me-1"></i>ä½¿ç”¨èªªæ˜</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div style="height: 70px;"></div>
    <div class="main-container">
        <div id="quiz-status" class="quiz-status" style="display: none;"><i class="fas fa-lock me-1"></i>æ¸¬é©—é€²è¡Œä¸­</div>
        <div class="quiz-header"><h1><i class="fas fa-brain me-3"></i>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«å°ˆæ¥­ç·´ç¿’ç³»çµ±</h1><p class="mb-0">ç¶“æ¿Ÿéƒ¨ç”¢æ¥­äººæ‰èƒ½åŠ›é‘‘å®š - è€ƒè©¦è¡åˆºå°ˆç”¨</p></div>
        <div class="database-selector" id="database-selector"><h3 class="mb-4"><i class="fas fa-database me-2"></i>é¸æ“‡ç·´ç¿’é¡Œåº«</h3><div class="row"><div class="col-md-6"><div class="database-card" data-type="ipas"><div class="text-center"><i class="fas fa-star fa-3x mb-3" style="color: #ffd700;"></i><h5>iPAS AIæ‡‰ç”¨è¦åŠƒå¸«</h5><p class="mb-2">ç¶“æ¿Ÿéƒ¨ç”¢æ¥­äººæ‰èƒ½åŠ›é‘‘å®š</p><small>â­ ä¸»è¦è€ƒè©¦é¡Œåº« - é‡é»ç·´ç¿’</small></div></div></div><div class="col-md-6"><div class="database-card" data-type="generative-ai"><div class="text-center"><i class="fas fa-robot fa-3x mb-3"></i><h5>ç”Ÿæˆå¼AIèªè­‰</h5><p class="mb-2">è³‡ç­–æœƒç”Ÿæˆå¼AIèƒ½åŠ›èªè­‰</p><small>è¼”åŠ©ç·´ç¿’ - è£œå¼·åŸºç¤çŸ¥è­˜</small></div></div></div></div></div>
        <div id="settings-panel" class="settings-panel"><div class="card border-0 shadow-sm"><div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><h5 class="mb-0"><i class="fas fa-cogs me-2"></i>æ¸¬é©—è¨­å®š</h5></div><div class="card-body p-4"><div class="row g-4 align-items-end"><div class="col-lg-3 col-md-6"><label class="form-label fw-bold"><i class="fas fa-list-ol me-2 text-primary"></i>é¡Œç›®æ•¸é‡</label><select id="question-count" class="form-select"><option value="10">10é¡Œ</option><option value="20">20é¡Œ</option><option value="40">40é¡Œ</option><option value="60" selected>60é¡Œ</option><option value="80">80é¡Œ</option></select></div><div class="col-lg-3 col-md-6"><label class="form-label fw-bold"><i class="fas fa-play-circle me-2 text-success"></i>ç·´ç¿’æ¨¡å¼</label><div class="d-flex flex-wrap gap-1"><button class="mode-btn active" data-mode="practice"><i class="fas fa-book me-1"></i>ç·´ç¿’</button><button class="mode-btn" data-mode="exam"><i class="fas fa-clock me-1"></i>è€ƒè©¦</button></div></div><div class="col-lg-3 col-md-6"><label class="form-label fw-bold"><i class="fas fa-redo me-2 text-info"></i>è¤‡ç¿’</label><button id="review-btn-main" class="btn btn-info w-100" disabled><i class="fas fa-redo me-2"></i>éŒ¯é¡Œè¤‡ç¿’</button></div><div class="col-lg-3 col-md-6"><label class="form-label fw-bold"><i class="fas fa-rocket me-2 text-danger"></i>æº–å‚™å°±ç·’</label><button id="start-btn" class="btn btn-danger w-100" disabled><i class="fas fa-play me-2"></i>é–‹å§‹ç·´ç¿’</button></div></div></div></div></div>
        <div id="quiz-container" class="quiz-container d-none"><button id="back-to-selection" class="back-to-selection"><i class="fas fa-arrow-left me-2"></i>è¿”å›é¡Œåº«é¸æ“‡</button><div class="progress mb-3"><div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div></div><div class="d-flex justify-content-between align-items-center mb-4"><h5 id="question-number" class="mb-0"></h5><div id="timer" class="timer"></div><span id="stats-display" class="badge bg-info"></span></div><h4 id="question-text" class="mb-4"></h4><div id="options-container" class="mb-4"></div><div id="explanation-box" class="explanation-box d-none"><h5 class="mb-3"><i class="fas fa-lightbulb me-2"></i>ç­”æ¡ˆè§£æ</h5><div id="explanation-content"></div></div></div>
        <div class="bottom-nav" id="bottom-navigation"><div class="container-fluid"><div class="row justify-content-center g-2"><div class="col-auto"><button id="prev-btn" class="btn btn-secondary" disabled><i class="fas fa-arrow-left me-1 d-sm-none"></i><span class="d-none d-sm-inline">ä¸Šä¸€é¡Œ</span></button></div><div class="col-auto"><button id="submit-btn" class="btn btn-primary" disabled><i class="fas fa-check me-1 d-sm-none"></i><span class="d-none d-sm-inline">æäº¤</span></button></div><div class="col-auto"><button id="explanation-btn" class="btn btn-info" disabled><i class="fas fa-lightbulb me-1 d-sm-none"></i><span class="d-none d-sm-inline">æŸ¥çœ‹è§£æ</span></button></div><div class="col-auto"><button id="next-btn" class="btn btn-warning" disabled><span class="d-none d-sm-inline">ä¸‹ä¸€é¡Œ</span><i class="fas fa-arrow-right ms-1 d-sm-none"></i></button></div><div class="col-auto"><button id="finish-btn" class="btn btn-success" disabled><i class="fas fa-flag-checkered me-1 d-sm-none"></i><span class="d-none d-sm-inline">å®Œæˆæ¸¬é©—</span></button></div></div></div></div>
    </div>
    <div class="modal fade" id="result-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">æ¸¬é©—çµæœ</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="result-content" style="max-height: 70vh; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button><button type="button" class="btn btn-success" id="restart-quiz-btn"><i class="fas fa-redo me-1"></i>é‡æ–°æ¸¬é©—</button><button type="button" class="btn btn-primary" id="review-wrong-btn"><i class="fas fa-times-circle me-1"></i>è¤‡ç¿’éŒ¯é¡Œ</button></div></div></div></div>
    <div class="modal fade" id="stats-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">å­¸ç¿’çµ±è¨ˆ</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="stats-content"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button><button type="button" class="btn btn-danger" id="reset-stats-btn">é‡ç½®å­¸ç¿’é€²åº¦</button></div></div></div></div>
    <div class="modal fade" id="help-modal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">iPASè€ƒè©¦æº–å‚™æŒ‡å—</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>ç‰ˆæœ¬ï¼š3.2.0 (å¤–éƒ¨å•å·æ¨¡çµ„ + éŒ¯èª¤ä¿®å¾©ç‰ˆ)</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button></div></div></div></div>
    <div id="loading-overlay" class="overlay d-none"><div class="loader"></div><div id="loading-text" class="loading-text">è™•ç†ä¸­...</div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const iPASQuizApp = {
            state: {
                isQuizActive: false, selectedDatabase: null, currentMode: 'practice', questions: [], currentQuestionIndex: 0,
                userAnswers: {}, questionMapping: {}, score: 0, wrongQuestions: [], startTime: null, timerId: null,
                userData: null, surveyCompleted: localStorage.getItem('iPAS_survey_completed') === 'true',
                currentTestResults: null, webhookUrl: 'https://nickleo9.zeabur.app/webhook/ipas-survey'
            },
            
            elements: {},
            modals: {},
            
            init() {
                const elIds = [ 'database-selector', 'settings-panel', 'quiz-container', 'start-btn', 'review-btn-main', 'back-btn', 'prev-btn', 'submit-btn', 'next-btn', 'finish-btn', 'explanation-btn', 'quiz-status', 'timer', 'question-number', 'question-text', 'options-container', 'explanation-box', 'explanation-content', 'progress-bar', 'stats-display', 'loading-overlay', 'loading-text' ];
                this.elements = elIds.reduce((acc, id) => { acc[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id); return acc; }, {});
                this.elements.databaseCards = document.querySelectorAll('.database-card');
                
                ['result-modal', 'stats-modal', 'help-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) this.modals[id.split('-')[0]] = new bootstrap.Modal(el);
                });

                this.state.userData = JSON.parse(localStorage.getItem('iPASQuizUserData')) || { incorrect: [] };
                this.attachEventListeners();
                this.updateReviewButtonState();
            },
            
            attachEventListeners() {
                this.elements.databaseCards.forEach(card => card.addEventListener('click', () => { if (!this.state.isQuizActive) this.selectDatabase(card.dataset.type); }));
                this.elements.startBtn.addEventListener('click', () => this.startQuiz());
                this.elements.reviewBtnMain.addEventListener('click', () => this.startReview());
                this.elements.backBtn.addEventListener('click', () => this.backToSelection());
                this.elements.prevBtn.addEventListener('click', () => this.prevQuestion());
                this.elements.submitBtn.addEventListener('click', () => this.submitAnswer());
                this.elements.nextBtn.addEventListener('click', () => this.nextQuestion());
                this.elements.finishBtn.addEventListener('click', () => this.finishQuiz());
                this.elements.explanationBtn.addEventListener('click', () => this.showCurrentExplanation());
                document.getElementById('save-btn').addEventListener('click', () => this.saveUserData(true));
                document.getElementById('stats-btn').addEventListener('click', () => this.modals.stats.show());
                document.getElementById('help-btn').addEventListener('click', () => this.modals.help.show());
                document.querySelectorAll('.mode-btn').forEach(btn => btn.addEventListener('click', () => { if (!this.state.isQuizActive) { document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.state.currentMode = btn.dataset.mode; }}));
                document.getElementById('review-wrong-btn').addEventListener('click', () => this.reviewWrongQuestions());
                document.getElementById('restart-quiz-btn').addEventListener('click', () => this.restartQuiz());
                document.getElementById('reset-stats-btn').addEventListener('click', () => this.resetProgress());
                window.addEventListener('beforeunload', () => this.saveUserData());
            },

            saveUserData(showMessage = false) {
                try {
                    localStorage.setItem('iPASQuizUserData', JSON.stringify(this.state.userData));
                    if (showMessage) this.showAlert('é€²åº¦å·²å„²å­˜', 'success');
                } catch (e) {
                    console.error("å„²å­˜å¤±æ•—:", e);
                }
            },

            updateReviewButtonState() {
                this.elements.reviewBtnMain.disabled = this.state.userData.incorrect.length === 0;
            },

            selectDatabase(type) {
                this.elements.databaseCards.forEach(c => c.classList.remove('selected'));
                document.querySelector(`[data-type="${type}"]`).classList.add('selected');
                this.state.selectedDatabase = type;
                this.elements.startBtn.disabled = false;
            },

            startQuiz() {
                if (!this.state.selectedDatabase) return this.showAlert('è«‹å…ˆé¸æ“‡é¡Œåº«', 'warning');
                const count = document.getElementById('question-count').value;
                const data = quizData[this.state.selectedDatabase];
                if (!data || data.length === 0) return this.showAlert('é¡Œåº«è¼‰å…¥ä¸­æˆ–è¼‰å…¥å¤±æ•—', 'error');
                this.state.questions = [...data].sort(() => 0.5 - Math.random()).slice(0, count);
                this._setupQuiz();
            },

            startReview() {
                const incorrectQuestions = this.state.userData.incorrect
                    .map(qText => (quizData.ipas.find(q => q.question === qText) || quizData['generative-ai'].find(q => q.question === qText)))
                    .filter(Boolean);
                if (incorrectQuestions.length === 0) return this.showAlert('æ²’æœ‰éŒ¯é¡Œå¯ä¾›è¤‡ç¿’', 'info');
                this.state.questions = incorrectQuestions;
                this.state.currentMode = 'review';
                this._setupQuiz();
            },
            
            _setupQuiz() {
                this.state.isQuizActive = true;
                this.state.currentQuestionIndex = 0;
                this.state.userAnswers = {};
                this.state.questionMapping = {};
                this.state.score = 0;
                this.state.wrongQuestions = [];
                this.state.startTime = new Date();
                this.elements.settingsPanel.classList.add('d-none');
                this.elements.quizContainer.classList.remove('d-none');
                if (this.state.currentMode === 'exam') this.startTimer();
                this.displayQuestion();
            },
            
            displayQuestion() {
                if (this.state.currentQuestionIndex >= this.state.questions.length) return this.finishQuiz();
                const q = this.state.questions[this.state.currentQuestionIndex];
                this.elements.questionNumber.textContent = `å•é¡Œ ${this.state.currentQuestionIndex + 1}/${this.state.questions.length}`;
                this.elements.questionText.textContent = q.question;
                
                if (!this.state.questionMapping[this.state.currentQuestionIndex]) {
                    const opts = q.options.map((text, i) => ({ text, originalIndex: i }));
                    this.state.questionMapping[this.state.currentQuestionIndex] = { shuffledOptions: [...opts].sort(() => 0.5 - Math.random()) };
                }
                const { shuffledOptions } = this.state.questionMapping[this.state.currentQuestionIndex];
                this.elements.optionsContainer.innerHTML = shuffledOptions.map((opt, i) => `<div class="form-check mb-2"><input class="option-input" type="radio" name="quiz-option" id="option-${i}" value="${opt.originalIndex}"><label class="option-label" for="option-${i}">${String.fromCharCode(65 + i)}. ${opt.text}</label></div>`).join('');

                const answered = this.state.userAnswers[this.state.currentQuestionIndex];
                if (answered) {
                    const radioToCheck = this.elements.optionsContainer.querySelector(`input[value="${answered.answer}"]`);
                    if(radioToCheck) radioToCheck.checked = true;
                    this.elements.optionsContainer.querySelectorAll('input').forEach(i => i.disabled = true);
                    this.showCurrentExplanation();
                } else {
                    this.elements.explanationBox.classList.add('d-none');
                }
                this.updateButtonStates();
            },
            
            submitAnswer() {
                const opt = this.elements.optionsContainer.querySelector('input[name="quiz-option"]:checked');
                if (!opt) return this.showAlert('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆ', 'warning');
                const q = this.state.questions[this.state.currentQuestionIndex];
                const isCorrect = parseInt(opt.value) === q.correct_answer_index;
                this.state.userAnswers[this.state.currentQuestionIndex] = { answer: opt.value, isCorrect };
                if (isCorrect) {
                    this.state.score++;
                    this.state.userData.incorrect = this.state.userData.incorrect.filter(item => item !== q.question);
                } else {
                    this.state.wrongQuestions.push(q);
                    if (!this.state.userData.incorrect.includes(q.question)) {
                        this.state.userData.incorrect.push(q.question);
                    }
                }
                this.saveUserData();
                this.updateReviewButtonState();
                if (this.state.currentMode !== 'exam') {
                    this.elements.optionsContainer.querySelectorAll('input').forEach(i => i.disabled = true);
                    this.showCurrentExplanation();
                }
                this.updateButtonStates();
            },
            
            showCurrentExplanation() {
                const q = this.state.questions[this.state.currentQuestionIndex];
                const ans = this.state.userAnswers[this.state.currentQuestionIndex];
                if (!ans) return;
                this.elements.explanationContent.innerHTML = `<div class="${ans.isCorrect ? 'correct' : 'incorrect'}">${ans.isCorrect ? 'âœ… ç­”å°äº†ï¼' : 'âŒ ç­”éŒ¯äº†ï¼'}</div><div class="highlight mt-2">${q.explanation || 'æš«ç„¡è§£æ'}</div>`;
                this.elements.explanationBox.classList.remove('d-none');
            },

            updateButtonStates() {
                const answered = this.state.currentQuestionIndex in this.state.userAnswers;
                this.elements.submitBtn.disabled = answered;
                this.elements.nextBtn.disabled = !answered || this.state.currentQuestionIndex === this.state.questions.length - 1;
                this.elements.explanationBtn.disabled = !answered;
                this.elements.finishBtn.disabled = false;
            },

            _cleanupModal(modalId) {
                const el = document.getElementById(modalId);
                if (el) {
                    const instance = bootstrap.Modal.getInstance(el);
                    if (instance) instance.dispose();
                    el.remove();
                }
            },
            
            finishQuiz() {
                if (this.state.timerId) this.stopTimer();
                this.state.isQuizActive = false;
                this.state.currentTestResults = this.calculateTestResults();
                if (!this.state.surveyCompleted) {
                    this.showMandatorySurvey();
                } else {
                    this.showResultChoice();
                }
            },
            
            calculateTestResults() {
                const total = this.state.questions.length, score = this.state.score, accuracy = total > 0 ? (score / total) : 0;
                const duration = this.state.startTime ? Math.round((new Date() - this.state.startTime) / 60000) : 0;
                return { score, total, accuracy, duration, wrongTopics: this.state.wrongQuestions.map(q => q.topic || 'æœªåˆ†é¡'), timestamp: new Date().toISOString() };
            },
            
            showResultChoice() {
                const modalId = 'resultChoiceModal';
                this._cleanupModal(modalId);
                const modalHTML = `<div class="modal fade" id="${modalId}" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">ğŸŠ æ¸¬é©—å®Œæˆï¼</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body text-center p-4"><div class="row"><div class="col-md-6 mb-3"><div class="card h-100 border-primary shadow-sm"><div class="card-body d-flex flex-column justify-content-center"><i class="fas fa-chart-line fa-3x text-primary mb-3"></i><h5>ç›´æ¥æŸ¥çœ‹çµæœ</h5><p class="text-muted small">ç«‹å³é¡¯ç¤ºæœ¬æ¬¡æ¸¬é©—åŸºæœ¬åˆ†æ</p><button class="btn btn-primary mt-auto" id="directResultBtn"><i class="fas fa-eye me-2"></i>æŸ¥çœ‹çµæœ</button></div></div></div><div class="col-md-6 mb-3"><div class="card h-100 border-warning shadow-sm"><div class="card-body d-flex flex-column justify-content-center"><i class="fas fa-clipboard-list fa-3x text-warning mb-3"></i><h5>å¿«é€Ÿå›é¥‹ (30ç§’)</h5><p class="text-muted small">å¹«åŠ©æˆ‘å€‘æ”¹å–„ï¼Œä¸¦ç²å¾—é€²éšåˆ†æ</p><button class="btn btn-warning mt-auto" id="surveyFeedbackBtn"><i class="fas fa-edit me-2"></i>å¡«å¯«å›é¥‹</button></div></div></div></div></div></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modalEl = document.getElementById(modalId);
                const modal = new bootstrap.Modal(modalEl);
                const handleTransition = (hideCallback, showCallback) => { modalEl.addEventListener('hidden.bs.modal', showCallback, { once: true }); hideCallback(); };
                document.getElementById('directResultBtn').addEventListener('click', () => handleTransition(() => modal.hide(), () => this.showResult()));
                document.getElementById('surveyFeedbackBtn').addEventListener('click', () => handleTransition(() => modal.hide(), () => this.showOptionalSurvey()));
                modal.show();
            },

            async showOptionalSurvey() {
                const modalId = 'optionalSurveyModal';
                this._cleanupModal(modalId);
                const modalHTML = `<div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div id="quickSurveyContainer" style="height: 100vh; overflow-y: auto;"><div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div></div></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                try {
                    const response = await fetch('./quick_survey.html');
                    if (!response.ok) throw new Error('å¿«é€Ÿå•å·æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼');
                    document.getElementById('quickSurveyContainer').innerHTML = await response.text();
                    this.initializeQuickSurvey();
                    new bootstrap.Modal(document.getElementById(modalId)).show();
                } catch (error) { this.showAlert(error.message, 'error'); }
            },

            initializeQuickSurvey() {
                document.getElementById('quickSurveyForm').addEventListener('submit', e => { e.preventDefault(); this.handleQuickSurveySubmit(); });
                document.getElementById('skip-quick-survey').addEventListener('click', e => { e.preventDefault(); this.closeSurveyModal('optionalSurveyModal'); this.showResult(); });
            },

            async handleQuickSurveySubmit() {
                this.showSubmittingState('submitQuickSurveyBtn', 'æäº¤ä¸­...');
                try {
                    const surveyData = { type: 'quick_feedback', ...Object.fromEntries(new FormData(document.getElementById('quickSurveyForm'))) };
                    await this.sendSurveyData(surveyData);
                    this.closeSurveyModal('optionalSurveyModal');
                    this.showEnhancedResult(true);
                } catch (error) { this.handleSurveyError('submitQuickSurveyBtn', 'æäº¤ä¸¦æŸ¥çœ‹åˆ†æå ±å‘Š'); }
            },

            async showMandatorySurvey() {
                const modalId = 'mandatorySurveyModal';
                this._cleanupModal(modalId);
                const modalHTML = `<div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-fullscreen"><div class="modal-content"><div id="surveyContainer" style="height: 100vh; overflow-y: auto;"><div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div></div></div></div></div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                try {
                    const response = await fetch('./full_survey.html');
                    if (!response.ok) throw new Error('å®Œæ•´å•å·æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼');
                    document.getElementById('surveyContainer').innerHTML = await response.text();
                    this.initializeEmbeddedSurvey();
                    new bootstrap.Modal(document.getElementById(modalId)).show();
                } catch (error) { this.showAlert(error.message, 'error'); }
            },
            
            initializeEmbeddedSurvey() {
                document.getElementById('embeddedSurveyForm').addEventListener('submit', e => { e.preventDefault(); this.handleSurveySubmit(); });
                document.querySelectorAll('input[name="favorite_features"]').forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const checked = document.querySelectorAll('input[name="favorite_features"]:checked');
                        document.querySelectorAll('input[name="favorite_features"]:not(:checked)').forEach(cb => cb.disabled = checked.length >= 3);
                    });
                });
            },
            
            async handleSurveySubmit() {
                this.showSubmittingState('submitFullSurveyBtn', 'æäº¤ä¸­...');
                try {
                    const surveyData = { type: 'full_survey', ...Object.fromEntries(new FormData(document.getElementById('embeddedSurveyForm'))) };
                    await this.sendSurveyData(surveyData);
                    localStorage.setItem('iPAS_survey_completed', 'true');
                    this.state.surveyCompleted = true;
                    this.closeSurveyModal('mandatorySurveyModal');
                    this.showEnhancedResult(false);
                } catch (error) { this.handleSurveyError('submitFullSurveyBtn', 'æäº¤å•å·ä¸¦æŸ¥çœ‹æ¸¬é©—çµæœ'); }
            },

            async sendSurveyData(surveyData) {
                const completeData = { ...this.state.currentTestResults, survey_data: surveyData };
                const response = await fetch(this.state.webhookUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(completeData) });
                if (!response.ok) throw new Error(`Webhook failed with status ${response.status}`);
            },
            
            handleSurveyError(buttonId, buttonText) {
                this.showAlert('å•å·æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
                const btn = document.getElementById(buttonId);
                if (btn) { btn.disabled = false; btn.innerHTML = `<i class="fas fa-paper-plane me-2"></i>${buttonText}`; }
            },

            closeSurveyModal(modalId) {
                const el = document.getElementById(modalId);
                if (el) {
                    const modal = bootstrap.Modal.getInstance(el);
                    if (modal) modal.hide();
                    el.addEventListener('hidden.bs.modal', () => this._cleanupModal(modalId), { once: true });
                }
            },

            showEnhancedResult(isQuickSurvey) {
                const { score, total, accuracy, duration } = this.state.currentTestResults;
                const accuracyPercent = Math.round(accuracy * 100);
                let html = `<div class="text-center mb-4"><h3>ğŸ‰ æ¸¬é©—åˆ†æå ±å‘Š</h3><div class="alert alert-success"><i class="fas fa-gift me-2"></i>æ„Ÿè¬æ‚¨${isQuickSurvey ? 'çš„å¿«é€Ÿå›é¥‹' : 'å®Œæˆå•å·'}ï¼</div></div><div class="row text-center mb-4"><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-primary">${score}</h4><small>å¾—åˆ†</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-info">${total}</h4><small>ç¸½é¡Œæ•¸</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-warning">${accuracyPercent}%</h4><small>æ­£ç¢ºç‡</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-secondary">${duration}</h4><small>ç”¨æ™‚(åˆ†)</small></div></div></div></div>`;
                if (this.state.wrongQuestions.length > 0) html += this._generateWrongQuestionsHTML();
                document.getElementById('result-content').innerHTML = html;
                this.modals.result.show();
            },
            
            showResult() {
                const { score, total, accuracy, duration } = this.state.currentTestResults;
                const accuracyPercent = Math.round(accuracy * 100);
                let html = `<div class="text-center mb-4"><h3>ğŸ“Š åŸºæœ¬æ¸¬é©—çµæœ</h3></div><div class="row text-center mb-4"><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-primary">${score}</h4><small>å¾—åˆ†</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-info">${total}</h4><small>ç¸½é¡Œæ•¸</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-warning">${accuracyPercent}%</h4><small>æ­£ç¢ºç‡</small></div></div></div><div class="col-md-3 col-6 mb-2"><div class="card border-0 bg-light"><div class="card-body p-2"><h4 class="text-secondary">${duration}</h4><small>ç”¨æ™‚(åˆ†)</small></div></div></div></div>`;
                if (this.state.wrongQuestions.length > 0) html += this._generateWrongQuestionsHTML();
                document.getElementById('result-content').innerHTML = html;
                this.modals.result.show();
            },

            _generateWrongQuestionsHTML() {
                let html = `<div class="card mt-4"><div class="card-header bg-danger text-white"><h5 class="mb-0">âŒ éŒ¯é¡Œåˆ†æ (${this.state.wrongQuestions.length}é¡Œ)</h5></div><div class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;">`;
                this.state.wrongQuestions.forEach(q => {
                    html += `<div class="list-group-item">${q.question} <span class="badge bg-secondary float-end">${q.topic || 'æœªåˆ†é¡'}</span></div>`;
                });
                return html + `</div></div>`;
            },
            
            reviewWrongQuestions() { this.modals.result.hide(); this.startReview(); },
            restartQuiz() { this.modals.result.hide(); this.backToSelection(); },
            resetProgress() { if (confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰é€²åº¦ï¼Ÿ')) { localStorage.clear(); this.state.userData = { incorrect: [] }; this.state.surveyCompleted = false; this.modals.stats.hide(); this.updateReviewButtonState(); this.showAlert('é€²åº¦å·²é‡ç½®', 'success'); } },
            backToSelection() { this.state.isQuizActive = false; if (this.state.timerId) this.stopTimer(); this.elements.quizContainer.classList.add('d-none'); this.elements.settingsPanel.classList.remove('d-none'); },
            nextQuestion() { if(this.state.currentQuestionIndex < this.state.questions.length - 1) { this.state.currentQuestionIndex++; this.displayQuestion(); } },
            prevQuestion() { if(this.state.currentQuestionIndex > 0 && this.state.currentMode !== 'exam') { this.state.currentQuestionIndex--; this.displayQuestion(); } },
            startTimer() { this.state.timerId = setInterval(() => { const elapsed = Math.floor((new Date() - this.state.startTime) / 1000); this.elements.timer.textContent = `è€ƒè©¦æ™‚é–“: ${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2, '0')}`; }, 1000); },
            stopTimer() { clearInterval(this.state.timerId); this.state.timerId = null; },
            showAlert(message, type = 'info') { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`; alertDiv.style.cssText = `top: 80px; right: 20px; z-index: 9999;`; alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`; document.body.appendChild(alertDiv); setTimeout(() => alertDiv.remove(), 5000); },
            showSubmittingState(buttonId, text) { const btn = document.getElementById(buttonId); if (btn) { btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${text}`; } }
        };

        document.addEventListener('DOMContentLoaded', () => {
            iPASQuizApp.init();
        });
    </script>
</body>
</html>
